# å¤šåª’ä½“æµæ•°æ®ç»“æ„è¯¦è§£ - ä»å…¥é—¨åˆ°ç†è§£

## ç›®å½•
1. [åŸºç¡€æ¦‚å¿µ](#åŸºç¡€æ¦‚å¿µ)
2. [è§†é¢‘æµæ•°æ®ç»“æ„](#è§†é¢‘æµæ•°æ®ç»“æ„)
3. [éŸ³é¢‘æµæ•°æ®ç»“æ„](#éŸ³é¢‘æµæ•°æ®ç»“æ„)
4. [å­—å¹•æµæ•°æ®ç»“æ„](#å­—å¹•æµæ•°æ®ç»“æ„)
5. [MP4å®¹å™¨æ ¼å¼](#mp4å®¹å™¨æ ¼å¼)
6. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
7. [å®è·µç¤ºä¾‹](#å®è·µç¤ºä¾‹)

---

## åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯"æµ"ï¼ˆStreamï¼‰ï¼Ÿ

åœ¨å¤šåª’ä½“é¢†åŸŸï¼Œ**æµ**æ˜¯æŒ‡æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„ä¸€ç³»åˆ—æ•°æ®åŒ…ã€‚æƒ³è±¡ä¸€ä¸‹ï¼š
- ğŸ“¹ **è§†é¢‘æµ**ï¼šå°±åƒä¸€å è¿ç»­çš„ç…§ç‰‡ï¼Œå¿«é€Ÿç¿»åŠ¨å°±æˆäº†åŠ¨ç”»
- ğŸ”Š **éŸ³é¢‘æµ**ï¼šå°±åƒè¿ç»­çš„å£°æ³¢æ•°æ®ï¼Œæ’­æ”¾å‡ºæ¥å°±æ˜¯å£°éŸ³
- ğŸ“ **å­—å¹•æµ**ï¼šå¸¦æœ‰æ—¶é—´æˆ³çš„æ–‡å­—ï¼Œåœ¨ç‰¹å®šæ—¶é—´æ˜¾ç¤º

### å®¹å™¨ vs ç¼–ç 

è¿™æ˜¯åˆå­¦è€…æœ€å®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        MP4 å®¹å™¨ï¼ˆContainerï¼‰         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   è§†é¢‘æµï¼ˆH.264ç¼–ç ï¼‰          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   éŸ³é¢‘æµï¼ˆAACç¼–ç ï¼‰            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   å­—å¹•æµï¼ˆæ–‡æœ¬ï¼‰               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ç¼–ç ï¼ˆCodecï¼‰**ï¼šå¦‚ä½•å‹ç¼©æ•°æ®ï¼ˆå¦‚H.264ã€AACï¼‰
- **å®¹å™¨ï¼ˆContainerï¼‰**ï¼šå¦‚ä½•æŠŠå¤šä¸ªæµæ‰“åŒ…åœ¨ä¸€èµ·ï¼ˆå¦‚MP4ã€MKVï¼‰

---

## è§†é¢‘æµæ•°æ®ç»“æ„

### 1. è§†é¢‘çš„åŸºæœ¬å•ä½ï¼šå¸§ï¼ˆFrameï¼‰

è§†é¢‘ç”±ä¸€å¸§ä¸€å¸§çš„å›¾åƒç»„æˆã€‚æ¯ç§’é’Ÿæœ‰å¤šå°‘å¸§ï¼Œå°±ç§°ä¸º**å¸§ç‡ï¼ˆFPSï¼‰**ã€‚

```python
# è§†é¢‘å¸§çš„åŸºæœ¬å±æ€§
class VideoFrame:
    timestamp: float        # æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
    frame_type: str        # å¸§ç±»å‹ï¼šI/P/B
    width: int             # å®½åº¦ï¼ˆåƒç´ ï¼‰
    height: int            # é«˜åº¦ï¼ˆåƒç´ ï¼‰
    data: bytes            # å®é™…çš„å›¾åƒæ•°æ®ï¼ˆå‹ç¼©åï¼‰
    size: int              # æ•°æ®å¤§å°ï¼ˆå­—èŠ‚ï¼‰
```

### 2. ä¸‰ç§å…³é”®å¸§ç±»å‹

è§†é¢‘å‹ç¼©çš„æ ¸å¿ƒæ˜¯ï¼š**ä¸æ˜¯æ¯ä¸€å¸§éƒ½å­˜å®Œæ•´å›¾åƒ**ã€‚

```
æ—¶é—´çº¿ï¼šâ†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’
å¸§ç±»å‹ï¼šI  P  P  B  B  P  P  I  P  P  B  B

Iå¸§ï¼ˆå…³é”®å¸§ï¼‰ï¼šå®Œæ•´å›¾åƒï¼Œå¯ç‹¬ç«‹è§£ç 
På¸§ï¼ˆé¢„æµ‹å¸§ï¼‰ï¼šè®°å½•ä¸å‰ä¸€å¸§çš„å·®å¼‚
Bå¸§ï¼ˆåŒå‘å¸§ï¼‰ï¼šå‚è€ƒå‰åå¸§ï¼Œå‹ç¼©ç‡æœ€é«˜
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**

æƒ³è±¡ä½ åœ¨æ‹ä¸€ä¸ªäººè¯´è¯çš„è§†é¢‘ï¼š
- ç¬¬1å¸§ï¼ˆIå¸§ï¼‰ï¼šå­˜å‚¨å®Œæ•´çš„è„¸éƒ¨å›¾åƒ [100KB]
- ç¬¬2å¸§ï¼ˆPå¸§ï¼‰ï¼šåªå­˜"å˜´å·´åŠ¨äº†ä¸€ç‚¹" [5KB]
- ç¬¬3å¸§ï¼ˆPå¸§ï¼‰ï¼šåªå­˜"å˜´å·´åˆåŠ¨äº†ä¸€ç‚¹" [5KB]

è¿™æ ·å°±å¤§å¤§å‡å°‘äº†æ–‡ä»¶å¤§å°ï¼

### 3. H.264ç¼–ç çš„NALå•å…ƒ

H.264ï¼ˆä¹Ÿå«AVCï¼‰æŠŠè§†é¢‘æ•°æ®ç»„ç»‡æˆ**NAL Units**ï¼ˆç½‘ç»œæŠ½è±¡å±‚å•å…ƒï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      NAL Unit ç»“æ„               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Start Code (0x00000001)  4å­—èŠ‚   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NAL Header               1å­—èŠ‚   â”‚
â”‚  â”œâ”€ forbidden_bit (1bit)        â”‚
â”‚  â”œâ”€ nal_ref_idc  (2bit)        â”‚
â”‚  â””â”€ nal_unit_type (5bit)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload Data             Nå­—èŠ‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¸¸è§çš„NALç±»å‹ï¼š**
- Type 1: éIDRå›¾åƒçš„slice
- Type 5: IDRå›¾åƒçš„sliceï¼ˆå…³é”®å¸§ï¼‰
- Type 6: SEIï¼ˆè¡¥å……å¢å¼ºä¿¡æ¯ï¼‰
- Type 7: SPSï¼ˆåºåˆ—å‚æ•°é›†ï¼‰- åŒ…å«è§†é¢‘åˆ†è¾¨ç‡ã€å¸§ç‡ç­‰
- Type 8: PPSï¼ˆå›¾åƒå‚æ•°é›†ï¼‰- åŒ…å«ç¼–ç å‚æ•°

### 4. å®Œæ•´çš„è§†é¢‘æµç»“æ„

```
è§†é¢‘æµ = SPS + PPS + ä¸€ç³»åˆ—NAL Units

ç¤ºä¾‹ï¼š
[SPS][PPS][IDR Frame][P Frame][P Frame][B Frame][B Frame][P Frame]...
  â†‘    â†‘       â†‘          â†‘        â†‘         â†‘        â†‘
 é…ç½®  é…ç½®   å…³é”®å¸§    ä¾èµ–å‰å¸§  ä¾èµ–å‰å¸§  ä¾èµ–åŒå‘  ä¾èµ–å‰å¸§
```

---

## éŸ³é¢‘æµæ•°æ®ç»“æ„

### 1. éŸ³é¢‘çš„åŸºæœ¬æ¦‚å¿µ

éŸ³é¢‘æ˜¯å°†è¿ç»­çš„å£°æ³¢è½¬æ¢æˆæ•°å­—ä¿¡å·ï¼š

```
è¿ç»­å£°æ³¢    é‡‡æ ·        é‡åŒ–        ç¼–ç 
  ~~~     --------   --------   --------
 /   \    |  |  |    01101010   AACæ•°æ®
/     \   |  |  |    11010101
       \  |  |  |    ...
```

**å…³é”®å‚æ•°ï¼š**
- **é‡‡æ ·ç‡ï¼ˆSample Rateï¼‰**ï¼šæ¯ç§’é‡‡æ ·å¤šå°‘æ¬¡ï¼Œå¦‚44.1kHzï¼ˆCDè´¨é‡ï¼‰
- **ä½æ·±åº¦ï¼ˆBit Depthï¼‰**ï¼šæ¯ä¸ªé‡‡æ ·ç”¨å¤šå°‘ä½è¡¨ç¤ºï¼Œå¦‚16bit
- **å£°é“æ•°ï¼ˆChannelsï¼‰**ï¼šå•å£°é“(1)ã€ç«‹ä½“å£°(2)ã€5.1ç¯ç»•(6)

### 2. AACéŸ³é¢‘å¸§ç»“æ„

AACæ˜¯æœ€å¸¸ç”¨çš„éŸ³é¢‘ç¼–ç æ ¼å¼ï¼ˆMP4é»˜è®¤ï¼‰ï¼š

```python
# AACéŸ³é¢‘å¸§
class AudioFrame:
    timestamp: float       # æ—¶é—´æˆ³
    sample_rate: int      # é‡‡æ ·ç‡ï¼š44100, 48000ç­‰
    channels: int         # å£°é“æ•°ï¼š1=å•å£°é“, 2=ç«‹ä½“å£°
    samples: int          # æ¯å¸§æ ·æœ¬æ•°ï¼šé€šå¸¸1024æˆ–2048
    data: bytes           # å‹ç¼©åçš„éŸ³é¢‘æ•°æ®
    size: int             # æ•°æ®å¤§å°
```

### 3. ADTSå¤´éƒ¨æ ¼å¼

AACéŸ³é¢‘é€šå¸¸å¸¦æœ‰**ADTSå¤´éƒ¨**ï¼ˆ7æˆ–9å­—èŠ‚ï¼‰ï¼Œæè¿°éŸ³é¢‘å‚æ•°ï¼š

```
ADTS Header (7 bytes)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Byte 0-1: Sync Word (0xFFF)               â”‚
â”‚ Byte 1:   MPEGç‰ˆæœ¬, Layer, ä¿æŠ¤ä½         â”‚
â”‚ Byte 2:   Profile, é‡‡æ ·ç‡ç´¢å¼•, å£°é“é…ç½®   â”‚
â”‚ Byte 3-4: å¸§é•¿åº¦                          â”‚
â”‚ Byte 5-6: ç¼“å†²åŒºå¤§å°, å¸§æ•°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. éŸ³é¢‘æ—¶é—´è®¡ç®—

```
æ¯å¸§æ—¶é•¿ = æ ·æœ¬æ•° / é‡‡æ ·ç‡

ç¤ºä¾‹ï¼š
- æ ·æœ¬æ•° = 1024
- é‡‡æ ·ç‡ = 44100 Hz
- æ¯å¸§æ—¶é•¿ = 1024 / 44100 â‰ˆ 23.22 æ¯«ç§’
```

---

## å­—å¹•æµæ•°æ®ç»“æ„

### 1. SRTæ ¼å¼ï¼ˆæœ€ç®€å•ï¼‰

```srt
1
00:00:00,000 --> 00:00:02,500
è¿™æ˜¯ç¬¬ä¸€å¥å­—å¹•

2
00:00:02,500 --> 00:00:05,000
è¿™æ˜¯ç¬¬äºŒå¥å­—å¹•
```

**ç»“æ„ï¼š**
```python
class SubtitleEntry:
    index: int              # åºå·
    start_time: float       # å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰
    end_time: float         # ç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰
    text: str               # å­—å¹•å†…å®¹
```

### 2. ASS/SSAæ ¼å¼ï¼ˆé«˜çº§æ ·å¼ï¼‰

```ass
[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.00,0:00:02.50,Default,,0,0,0,,è¿™æ˜¯å­—å¹•
```

æ”¯æŒï¼š
- å­—ä½“æ ·å¼
- é¢œè‰²
- ä½ç½®
- ç‰¹æ•ˆ

### 3. WebVTTæ ¼å¼ï¼ˆWebæ ‡å‡†ï¼‰

```vtt
WEBVTT

00:00:00.000 --> 00:00:02.500
è¿™æ˜¯ç¬¬ä¸€å¥å­—å¹•

00:00:02.500 --> 00:00:05.000 position:50% align:middle
è¿™æ˜¯å±…ä¸­çš„å­—å¹•
```

### 4. å†…åµŒå­—å¹• vs å¤–æŒ‚å­—å¹•

```
å†…åµŒå­—å¹•ï¼ˆçƒ§å½•ï¼‰ï¼š
  ç”»åœ¨è§†é¢‘å¸§ä¸Šï¼Œæ— æ³•å…³é—­
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   è§†é¢‘ç”»é¢   â”‚
  â”‚   å¸¦å­—å¹•    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤–æŒ‚å­—å¹•ï¼ˆè½¯å­—å¹•ï¼‰ï¼š
  ç‹¬ç«‹çš„å­—å¹•æµï¼Œå¯ä»¥å¼€å…³
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   è§†é¢‘æµ    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   éŸ³é¢‘æµ    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   å­—å¹•æµ    â”‚  â† å¯é€‰
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MP4å®¹å™¨æ ¼å¼

### 1. Box/Atomæ¶æ„

MP4ä½¿ç”¨**Box**ï¼ˆä¹Ÿå«Atomï¼‰ç»“æ„ç»„ç»‡æ•°æ®ï¼Œå°±åƒä¿„ç½—æ–¯å¥—å¨ƒï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ftyp (æ–‡ä»¶ç±»å‹)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  moov (å…ƒæ•°æ®å®¹å™¨)                  â”‚
â”‚  â”œâ”€ mvhd (å½±ç‰‡å¤´)                   â”‚
â”‚  â”œâ”€ trak (è§†é¢‘è½¨é“)                 â”‚
â”‚  â”‚  â”œâ”€ tkhd (è½¨é“å¤´)                â”‚
â”‚  â”‚  â””â”€ mdia (åª’ä½“ä¿¡æ¯)              â”‚
â”‚  â”‚     â”œâ”€ mdhd (åª’ä½“å¤´)             â”‚
â”‚  â”‚     â”œâ”€ hdlr (å¤„ç†å™¨)             â”‚
â”‚  â”‚     â””â”€ minf (åª’ä½“ä¿¡æ¯)           â”‚
â”‚  â”‚        â”œâ”€ vmhd (è§†é¢‘åª’ä½“å¤´)      â”‚
â”‚  â”‚        â”œâ”€ dinf (æ•°æ®ä¿¡æ¯)        â”‚
â”‚  â”‚        â””â”€ stbl (æ ·æœ¬è¡¨)          â”‚
â”‚  â”‚           â”œâ”€ stsd (æ ·æœ¬æè¿°)     â”‚
â”‚  â”‚           â”œâ”€ stts (æ—¶é—´->æ ·æœ¬)   â”‚
â”‚  â”‚           â”œâ”€ stsc (æ ·æœ¬->å—)     â”‚
â”‚  â”‚           â”œâ”€ stsz (æ ·æœ¬å¤§å°)     â”‚
â”‚  â”‚           â””â”€ stco (å—åç§»)       â”‚
â”‚  â””â”€ trak (éŸ³é¢‘è½¨é“)                 â”‚
â”‚     â””â”€ ... (ç±»ä¼¼ç»“æ„)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  mdat (å®é™…çš„åª’ä½“æ•°æ®)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Boxçš„åŸºæœ¬ç»“æ„

æ¯ä¸ªBoxéƒ½æœ‰ç»Ÿä¸€çš„æ ¼å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Size    (4 bytes)    â”‚  â† Boxæ€»å¤§å°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Type    (4 bytes)    â”‚  â† Boxç±»å‹ï¼ˆå¦‚'ftyp'ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data    (N bytes)    â”‚  â† å®é™…æ•°æ®æˆ–å­Box
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å…³é”®Boxè¯¦è§£

#### ftyp - æ–‡ä»¶ç±»å‹Box

```python
{
    'type': 'ftyp',
    'major_brand': 'isom',      # ä¸»è¦å“ç‰Œ
    'minor_version': 512,       # ç‰ˆæœ¬å·
    'compatible_brands': [      # å…¼å®¹å“ç‰Œ
        'isom',
        'iso2',
        'avc1',
        'mp41'
    ]
}
```

#### moov - å…ƒæ•°æ®å®¹å™¨

åŒ…å«æ‰€æœ‰çš„ç´¢å¼•ä¿¡æ¯ï¼Œå‘Šè¯‰æ’­æ”¾å™¨ï¼š
- æœ‰å‡ ä¸ªè½¨é“ï¼ˆè§†é¢‘ã€éŸ³é¢‘ã€å­—å¹•ï¼‰
- æ¯ä¸ªè½¨é“çš„ç¼–ç æ ¼å¼
- æ¯ä¸€å¸§æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®
- æ—¶é•¿ã€ç ç‡ç­‰ä¿¡æ¯

#### mdat - åª’ä½“æ•°æ®

çœŸæ­£çš„éŸ³è§†é¢‘æ•°æ®éƒ½åœ¨è¿™é‡Œï¼Œä½†æ˜¯æ˜¯**äº¤ç»‡å­˜å‚¨**çš„ï¼š

```
[è§†é¢‘å¸§1][éŸ³é¢‘å¸§1-10][è§†é¢‘å¸§2][éŸ³é¢‘å¸§11-20]...
```

ä¸ºä»€ä¹ˆäº¤ç»‡ï¼Ÿä¸ºäº†æ’­æ”¾æµç•…ï¼Œé¿å…é¢‘ç¹è·³è½¬æ–‡ä»¶ä½ç½®ã€‚

### 4. æ ·æœ¬è¡¨ï¼ˆSample Tableï¼‰çš„ä½œç”¨

Sample Tableæ˜¯MP4çš„æ ¸å¿ƒï¼Œå®ƒå»ºç«‹äº†ç´¢å¼•ï¼š

```python
# stts - æ—¶é—´åˆ°æ ·æœ¬çš„æ˜ å°„
time_to_sample = [
    {'sample_count': 100, 'sample_delta': 1001},  # å‰100å¸§ï¼Œæ¯å¸§é—´éš”1001ä¸ªæ—¶é—´å•ä½
    {'sample_count': 50, 'sample_delta': 2002},   # å50å¸§ï¼Œé—´éš”åŠ å€
]

# stsz - æ¯ä¸ªæ ·æœ¬çš„å¤§å°
sample_sizes = [12543, 1234, 1345, 15678, ...]  # æ¯å¸§çš„å­—èŠ‚æ•°

# stco - å—åç§»
chunk_offsets = [8192, 45678, 98765, ...]  # æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®

# stsc - æ ·æœ¬åˆ°å—çš„æ˜ å°„
sample_to_chunk = [
    {'first_chunk': 1, 'samples_per_chunk': 10, 'sample_desc_index': 1},
    {'first_chunk': 5, 'samples_per_chunk': 15, 'sample_desc_index': 1},
]
```

**å¦‚ä½•å®šä½ç¬¬Nå¸§ï¼Ÿ**

1. é€šè¿‡`stsc`æ‰¾åˆ°è¯¥å¸§å±äºå“ªä¸ªchunk
2. é€šè¿‡`stco`æ‰¾åˆ°chunkåœ¨æ–‡ä»¶ä¸­çš„åç§»
3. é€šè¿‡`stsz`ç´¯åŠ å‰é¢å¸§çš„å¤§å°ï¼Œå¾—åˆ°è¯¥å¸§åœ¨chunkä¸­çš„åç§»
4. è¯»å–å¯¹åº”å¤§å°çš„æ•°æ®

### 5. å¤šè½¨é“çš„æ—¶é—´åŒæ­¥

```
è§†é¢‘æ—¶é—´è½´ï¼š   |----Frame1----|----Frame2----|----Frame3----|
              0ms          33ms          66ms          100ms

éŸ³é¢‘æ—¶é—´è½´ï¼š   |--F1--|--F2--|--F3--|--F4--|--F5--|--F6--|--F7--|
              0ms   23ms   46ms   69ms   92ms

å­—å¹•æ—¶é—´è½´ï¼š   |----------Sub1----------|
              0ms                     2500ms
```

**æ—¶é—´åŸºå‡†ï¼ˆTime Scaleï¼‰ï¼š**
- æ¯ä¸ªè½¨é“æœ‰è‡ªå·±çš„time scale
- è§†é¢‘å¸¸ç”¨ï¼š90000ï¼ˆ90kHzï¼‰
- éŸ³é¢‘å¸¸ç”¨ï¼šé‡‡æ ·ç‡ï¼ˆå¦‚44100ï¼‰

```python
# è½¬æ¢ä¸ºå®é™…æ—¶é—´
real_time = timestamp / time_scale  # ç§’
```

---

## å®Œæ•´æµç¨‹å›¾

### 1. MP4æ–‡ä»¶çš„åˆ›å»ºæµç¨‹

```mermaid
graph TB
    Start["åŸå§‹æ•°æ®é‡‡é›†"]
    
    subgraph é‡‡é›†é˜¶æ®µ
        Camera["æ‘„åƒå¤´é‡‡é›†<br/>(RGBå›¾åƒ)"]
        Mic["éº¦å…‹é£é‡‡é›†<br/>(PCMéŸ³é¢‘)"]
        Sub["å­—å¹•åˆ¶ä½œ<br/>(çº¯æ–‡æœ¬)"]
    end
    
    subgraph ç¼–ç é˜¶æ®µ
        H264["H.264ç¼–ç å™¨<br/>(å‹ç¼©è§†é¢‘)"]
        AAC["AACç¼–ç å™¨<br/>(å‹ç¼©éŸ³é¢‘)"]
        SubEnc["å­—å¹•ç¼–ç å™¨"]
    end
    
    subgraph æ‰“åŒ…é˜¶æ®µ
        Muxer["MP4 Muxer (å¤ç”¨å™¨)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ åˆ›å»ºBoxç»“æ„<br/>â€¢ äº¤ç»‡éŸ³è§†é¢‘æ•°æ®<br/>â€¢ ç”Ÿæˆç´¢å¼•è¡¨<br/>â€¢ å†™å…¥å…ƒæ•°æ®"]
    end
    
    Output["output.mp4"]
    
    Start --> Camera
    Start --> Mic
    Start --> Sub
    
    Camera --> H264
    Mic --> AAC
    Sub --> SubEnc
    
    H264 --> Muxer
    AAC --> Muxer
    SubEnc --> Muxer
    
    Muxer --> Output
    
    style Start fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style Output fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style Muxer fill:#fff3e0,stroke:#e65100,stroke-width:2px
```

### 2. MP4æ–‡ä»¶çš„æ’­æ”¾æµç¨‹

```mermaid
graph TB
    Input["video.mp4"]
    Parse["è¯»å–ftypå’Œmoov<br/>(è§£æå…ƒæ•°æ®)"]
    SampleTable["è§£æSample Table<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ å»ºç«‹æ—¶é—´ç´¢å¼•<br/>â€¢ å»ºç«‹å¤§å°ç´¢å¼•<br/>â€¢ å»ºç«‹ä½ç½®ç´¢å¼•"]
    Seek["æ ¹æ®æ’­æ”¾æ—¶é—´å®šä½æ•°æ®"]
    
    ReadVideo["ä»mdatè¯»å–è§†é¢‘å¸§"]
    ReadAudio["ä»mdatè¯»å–éŸ³é¢‘å¸§"]
    
    DecodeVideo["H.264è§£ç å™¨"]
    DecodeAudio["AACè§£ç å™¨"]
    
    Display["æ˜¾ç¤ºåˆ°å±å¹•"]
    Speaker["è¾“å‡ºåˆ°æ‰¬å£°å™¨"]
    
    Input --> Parse
    Parse --> SampleTable
    SampleTable --> Seek
    Seek --> ReadVideo
    Seek --> ReadAudio
    
    ReadVideo --> DecodeVideo
    ReadAudio --> DecodeAudio
    
    DecodeVideo --> Display
    DecodeAudio --> Speaker
    
    style Input fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style SampleTable fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style Display fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    style Speaker fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
```

### 3. æ•°æ®åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º

```python
# å®Œæ•´çš„MP4æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º
class MP4File:
    # æ–‡ä»¶çº§åˆ«ä¿¡æ¯
    file_type: str = "mp4"
    duration: float = 120.5  # ç§’
    size: int = 10485760  # å­—èŠ‚
    
    # è§†é¢‘è½¨é“
    video_track = {
        'codec': 'H.264',
        'width': 1920,
        'height': 1080,
        'fps': 30,
        'bitrate': 5000000,  # 5Mbps
        'frames': [
            {'pts': 0, 'dts': 0, 'type': 'I', 'offset': 8192, 'size': 12543},
            {'pts': 33, 'dts': 33, 'type': 'P', 'offset': 20735, 'size': 1234},
            # ... æ›´å¤šå¸§
        ]
    }
    
    # éŸ³é¢‘è½¨é“
    audio_track = {
        'codec': 'AAC',
        'sample_rate': 44100,
        'channels': 2,
        'bitrate': 128000,  # 128kbps
        'frames': [
            {'pts': 0, 'offset': 45678, 'size': 345},
            {'pts': 23, 'offset': 46023, 'size': 342},
            # ... æ›´å¤šå¸§
        ]
    }
    
    # å­—å¹•è½¨é“ï¼ˆå¦‚æœæœ‰ï¼‰
    subtitle_track = {
        'format': 'srt',
        'language': 'zh-CN',
        'entries': [
            {'start': 0, 'end': 2.5, 'text': 'ç¬¬ä¸€å¥'},
            {'start': 2.5, 'end': 5.0, 'text': 'ç¬¬äºŒå¥'},
            # ... æ›´å¤šæ¡ç›®
        ]
    }
```

---

## å®è·µç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ‰‹åŠ¨è§£æMP4æ–‡ä»¶å¤´

```python
import struct

def read_box(file):
    """è¯»å–ä¸€ä¸ªBox"""
    size_data = file.read(4)
    if len(size_data) < 4:
        return None
    
    size = struct.unpack('>I', size_data)[0]
    box_type = file.read(4).decode('ascii')
    
    return {
        'size': size,
        'type': box_type,
        'offset': file.tell() - 8
    }

# ä½¿ç”¨ç¤ºä¾‹
with open('video.mp4', 'rb') as f:
    box = read_box(f)
    print(f"ç¬¬ä¸€ä¸ªBox: {box['type']}, å¤§å°: {box['size']} å­—èŠ‚")
```

### ç¤ºä¾‹2ï¼šæå–è§†é¢‘å…³é”®å¸§

```python
import cv2

def extract_keyframes(video_path, output_dir):
    """æå–è§†é¢‘çš„æ‰€æœ‰Iå¸§ï¼ˆå…³é”®å¸§ï¼‰"""
    cap = cv2.VideoCapture(video_path)
    frame_count = 0
    keyframe_count = 0
    
    while True:
        ret, frame = cap.read()
        if not ret:
            break
        
        # OpenCVæ— æ³•ç›´æ¥åˆ¤æ–­å¸§ç±»å‹ï¼Œ
        # è¿™é‡Œç®€åŒ–ä¸ºæ¯30å¸§ï¼ˆ1ç§’ï¼‰ä¿å­˜ä¸€æ¬¡
        if frame_count % 30 == 0:
            cv2.imwrite(f'{output_dir}/keyframe_{keyframe_count}.jpg', frame)
            keyframe_count += 1
        
        frame_count += 1
    
    cap.release()
    print(f"æå–äº† {keyframe_count} ä¸ªå…³é”®å¸§")
```

### ç¤ºä¾‹3ï¼šéŸ³é¢‘æ³¢å½¢å¯è§†åŒ–

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy.io import wavfile

def visualize_audio(audio_path):
    """å¯è§†åŒ–éŸ³é¢‘æ³¢å½¢"""
    sample_rate, data = wavfile.read(audio_path)
    
    # å¦‚æœæ˜¯ç«‹ä½“å£°ï¼Œåªå–ä¸€ä¸ªå£°é“
    if len(data.shape) > 1:
        data = data[:, 0]
    
    # è®¡ç®—æ—¶é—´è½´
    duration = len(data) / sample_rate
    time = np.linspace(0, duration, len(data))
    
    # ç»˜åˆ¶æ³¢å½¢
    plt.figure(figsize=(12, 4))
    plt.plot(time, data)
    plt.xlabel('æ—¶é—´ (ç§’)')
    plt.ylabel('æŒ¯å¹…')
    plt.title('éŸ³é¢‘æ³¢å½¢')
    plt.show()
```

---

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆMP4æ–‡ä»¶ä¸èƒ½å¿«è¿›ï¼Ÿ

**A:** è¿™é€šå¸¸æ˜¯å› ä¸º`moov` boxåœ¨æ–‡ä»¶æœ«å°¾ã€‚æ’­æ”¾å™¨éœ€è¦å…ˆè¯»å–moovæ‰èƒ½å»ºç«‹ç´¢å¼•ï¼Œä½†å¦‚æœæ–‡ä»¶å¾ˆå¤§ä¸”moovåœ¨æœ«å°¾ï¼Œå°±éœ€è¦ä¸‹è½½æ•´ä¸ªæ–‡ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨å·¥å…·å°†moovç§»åˆ°æ–‡ä»¶å¼€å¤´ï¼ˆFast Startï¼‰ï¼š
```bash
ffmpeg -i input.mp4 -movflags faststart -c copy output.mp4
```

### Q2: è§†é¢‘å’ŒéŸ³é¢‘ä¸åŒæ­¥æ€ä¹ˆåŠï¼Ÿ

**A:** é€šå¸¸æ˜¯ç”±äºPTSï¼ˆæ˜¾ç¤ºæ—¶é—´æˆ³ï¼‰å’ŒDTSï¼ˆè§£ç æ—¶é—´æˆ³ï¼‰æ··ä¹±ã€‚æ£€æŸ¥ï¼š
1. æ—¶é—´åŸºå‡†æ˜¯å¦ä¸€è‡´
2. æ˜¯å¦æœ‰å¸§ä¸¢å¤±
3. ç¼–ç æ—¶æ˜¯å¦æ­£ç¡®è®¾ç½®æ—¶é—´æˆ³

### Q3: å¦‚ä½•å‡å°è§†é¢‘æ–‡ä»¶å¤§å°ï¼Ÿ

**A:** å¯ä»¥è°ƒæ•´ï¼š
1. **åˆ†è¾¨ç‡**ï¼š1080p â†’ 720p
2. **ç ç‡**ï¼šé™ä½è§†é¢‘bitrate
3. **å¸§ç‡**ï¼š60fps â†’ 30fps
4. **ç¼–ç å™¨**ï¼šä½¿ç”¨æ›´é«˜æ•ˆçš„H.265
5. **GOPå¤§å°**ï¼šå¢åŠ Iå¸§é—´éš”

### Q4: ä»€ä¹ˆæ˜¯GOPï¼Ÿ

**A:** GOPï¼ˆGroup of Picturesï¼‰æ˜¯ä¸€ç»„è¿ç»­çš„å¸§ï¼Œä»ä¸€ä¸ªIå¸§å¼€å§‹åˆ°ä¸‹ä¸€ä¸ªIå¸§ä¹‹å‰ã€‚

```
GOP 1: [I P P B B P P P]
GOP 2: [I P P B B P P P]
```

GOPè¶Šå¤§ï¼Œå‹ç¼©ç‡è¶Šé«˜ï¼Œä½†å¯»å€é€Ÿåº¦è¶Šæ…¢ã€‚

---

## æ¨èå·¥å…·

### åˆ†æå·¥å…·
- **ffmpeg/ffprobe**: å‘½ä»¤è¡Œå¤šåª’ä½“å·¥å…·
- **MediaInfo**: GUIåª’ä½“ä¿¡æ¯æŸ¥çœ‹å™¨
- **MP4Box**: MP4æ–‡ä»¶æ“ä½œå·¥å…·
- **Hex Editor**: æŸ¥çœ‹äºŒè¿›åˆ¶æ•°æ®

### Pythonåº“
- **pymediainfo**: è¯»å–åª’ä½“ä¿¡æ¯
- **opencv-python**: è§†é¢‘å¤„ç†
- **pydub**: éŸ³é¢‘å¤„ç†
- **ffmpeg-python**: ffmpegçš„Pythonå°è£…

### å®ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
ffprobe -show_format -show_streams video.mp4

# æŸ¥çœ‹æ‰€æœ‰å¸§ä¿¡æ¯
ffprobe -show_frames video.mp4

# æå–è§†é¢‘æµ
ffmpeg -i video.mp4 -c:v copy -an video_only.mp4

# æå–éŸ³é¢‘æµ
ffmpeg -i video.mp4 -c:a copy -vn audio_only.aac

# æå–å­—å¹•
ffmpeg -i video.mp4 -map 0:s:0 subtitle.srt
```

---

## æ€»ç»“

ç†è§£å¤šåª’ä½“æµçš„å…³é”®ç‚¹ï¼š

1. **åˆ†å±‚ç†è§£**ï¼š
   - åº”ç”¨å±‚ï¼šæ’­æ”¾å™¨
   - å®¹å™¨å±‚ï¼šMP4æ ¼å¼
   - ç¼–ç å±‚ï¼šH.264ã€AAC
   - æ•°æ®å±‚ï¼šäºŒè¿›åˆ¶æ•°æ®

2. **æ—¶é—´åŒæ­¥**ï¼š
   - æ‰€æœ‰æµéƒ½åŸºäºæ—¶é—´æˆ³å¯¹é½
   - ä¸åŒæµå¯ä»¥æœ‰ä¸åŒçš„æ—¶é—´åŸºå‡†

3. **å‹ç¼©åŸç†**ï¼š
   - è§†é¢‘åˆ©ç”¨å¸§é—´ç›¸ä¼¼æ€§ï¼ˆP/Bå¸§ï¼‰
   - éŸ³é¢‘åˆ©ç”¨äººè€³ç‰¹æ€§ï¼ˆAACï¼‰

4. **ç´¢å¼•æœºåˆ¶**ï¼š
   - Sample Tableæä¾›å¿«é€Ÿå®šä½
   - äº¤ç»‡å­˜å‚¨æé«˜æ’­æ”¾æ•ˆç‡

é€šè¿‡æœ¬æ–‡æ¡£å’Œé…å¥—demoï¼Œä½ åº”è¯¥å¯¹å¤šåª’ä½“æµæœ‰äº†å…¨é¢çš„ç†è§£ã€‚ç»§ç»­æ·±å…¥å­¦ä¹ å¯ä»¥æ¢ç´¢ï¼š
- æ›´é«˜æ•ˆçš„ç¼–ç å™¨ï¼ˆAV1ã€VP9ï¼‰
- æµåª’ä½“åè®®ï¼ˆHLSã€DASHï¼‰
- å®æ—¶é€šä¿¡ï¼ˆWebRTCï¼‰
- GPUåŠ é€Ÿç¼–è§£ç 

ç¥å­¦ä¹ æ„‰å¿«ï¼ğŸ‰

