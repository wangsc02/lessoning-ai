# WebRTCæ·±å…¥å­¦ä¹ æŒ‡å— - ä»åŸç†åˆ°å®è·µ

## ç›®å½•
1. [WebRTCæ˜¯ä»€ä¹ˆ](#webrtcæ˜¯ä»€ä¹ˆ)
2. [æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„](#æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„)
3. [ä¿¡ä»¤è¿‡ç¨‹è¯¦è§£](#ä¿¡ä»¤è¿‡ç¨‹è¯¦è§£)
4. [NATç©¿é€æŠ€æœ¯](#natç©¿é€æŠ€æœ¯)
5. [åª’ä½“åå•†ä¸SDP](#åª’ä½“åå•†ä¸sdp)
6. [ICEå€™é€‰è€…æœºåˆ¶](#iceå€™é€‰è€…æœºåˆ¶)
7. [æ•°æ®ä¼ è¾“å±‚](#æ•°æ®ä¼ è¾“å±‚)
8. [å®Œæ•´é€šä¿¡æµç¨‹](#å®Œæ•´é€šä¿¡æµç¨‹)
9. [å®æˆ˜åº”ç”¨åœºæ™¯](#å®æˆ˜åº”ç”¨åœºæ™¯)
10. [æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜æ’æŸ¥](#æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜æ’æŸ¥)

---

## WebRTCæ˜¯ä»€ä¹ˆ

### ç®€å•å®šä¹‰

**WebRTCï¼ˆWeb Real-Time Communicationï¼‰** æ˜¯ä¸€é¡¹è®©æµè§ˆå™¨å’Œç§»åŠ¨åº”ç”¨èƒ½å¤Ÿè¿›è¡Œ**å®æ—¶éŸ³è§†é¢‘é€šä¿¡**å’Œ**æ•°æ®ä¼ è¾“**çš„æŠ€æœ¯ï¼Œæ— éœ€å®‰è£…ä»»ä½•æ’ä»¶ã€‚

### ç”Ÿæ´»åŒ–ç†è§£

æƒ³è±¡ä¸€ä¸‹ï¼š
- ğŸ“ **ä¼ ç»Ÿç”µè¯**ï¼šéœ€è¦ç”µè¯å…¬å¸çš„äº¤æ¢æœºè½¬æ¥
- ğŸ’» **Skypeæ—©æœŸ**ï¼šéœ€è¦ä¸‹è½½å®‰è£…å®¢æˆ·ç«¯
- ğŸŒ **WebRTC**ï¼šæ‰“å¼€ç½‘é¡µå°±èƒ½è§†é¢‘é€šè¯ï¼Œå°±åƒé­”æ³•ä¸€æ ·ï¼

```
ä¼ ç»Ÿæ–¹å¼ï¼š
ç”¨æˆ·A â”€â”€â†’ æœåŠ¡å™¨ â”€â”€â†’ ç”¨æˆ·B
      (æ‰€æœ‰æ•°æ®éƒ½ç»è¿‡æœåŠ¡å™¨)

WebRTCæ–¹å¼ï¼š
ç”¨æˆ·A â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç”¨æˆ·B
      (ç›´æ¥ç‚¹å¯¹ç‚¹è¿æ¥)
      â†‘
      â””â”€ æœåŠ¡å™¨åªè´Ÿè´£å»ºç«‹è¿æ¥
```

### æ ¸å¿ƒç‰¹ç‚¹

1. **P2Pé€šä¿¡**ï¼šä¸¤ä¸ªæµè§ˆå™¨ç›´æ¥é€šä¿¡ï¼Œå»¶è¿Ÿä½
2. **æ— éœ€æ’ä»¶**ï¼šæµè§ˆå™¨åŸç”Ÿæ”¯æŒ
3. **åŠ å¯†å®‰å…¨**ï¼šå¼ºåˆ¶ä½¿ç”¨åŠ å¯†ï¼ˆDTLSã€SRTPï¼‰
4. **è·¨å¹³å°**ï¼šWebã€iOSã€Androidç»Ÿä¸€æ ‡å‡†
5. **å¼€æºå…è´¹**ï¼šGoogleå¼€æºçš„æŠ€æœ¯

---

## æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„

### 1. WebRTCçš„ä¸‰å¤§API

```javascript
// ä¼ªä»£ç ï¼šWebRTCçš„ä¸‰å¤§æ ¸å¿ƒAPI

// 1. MediaStream API - è·å–éŸ³è§†é¢‘æµ
getUserMedia() {
    è¿”å›: æœ¬åœ°æ‘„åƒå¤´/éº¦å…‹é£çš„åª’ä½“æµ
    ç”¨é€”: é‡‡é›†éŸ³è§†é¢‘
}

// 2. RTCPeerConnection API - å»ºç«‹P2Pè¿æ¥
RTCPeerConnection() {
    åŠŸèƒ½: 
    - ç®¡ç†è¿æ¥çŠ¶æ€
    - å¤„ç†åª’ä½“æµä¼ è¾“
    - å¤„ç†NATç©¿é€
    - ç¼–è§£ç éŸ³è§†é¢‘
}

// 3. RTCDataChannel API - ä¼ è¾“ä»»æ„æ•°æ®
RTCDataChannel() {
    åŠŸèƒ½: ä¼ è¾“æ–‡æœ¬ã€æ–‡ä»¶ç­‰ä»»æ„æ•°æ®
    ç‰¹ç‚¹: ä½å»¶è¿Ÿã€å¯é æˆ–ä¸å¯é ä¼ è¾“
}
```

### 2. WebRTCæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚                              â”‚
â”‚  (è§†é¢‘ä¼šè®®ã€åœ¨çº¿æ•™è‚²ã€è¿œç¨‹ååŠ©ç­‰)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WebRTC JavaScript API                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ getUserMedia â”‚ â”‚PeerConnectionâ”‚ â”‚  DataChannel    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WebRTCæ ¸å¿ƒå¼•æ“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¼šè¯ç®¡ç† (Session Management)                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ éŸ³é¢‘å¼•æ“     â”‚        â”‚ è§†é¢‘å¼•æ“             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ - å›å£°æ¶ˆé™¤   â”‚        â”‚ - ç¼–è§£ç (VP8/H264)  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ - å™ªå£°æŠ‘åˆ¶   â”‚        â”‚ - æŠ–åŠ¨ç¼“å†²          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ - è‡ªåŠ¨å¢ç›Š   â”‚        â”‚ - ä¸¢åŒ…æ¢å¤          â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¼ è¾“å±‚ (Transport)                               â”‚  â”‚
â”‚  â”‚  - SRTP (å®‰å…¨å®æ—¶ä¼ è¾“åè®®)                        â”‚  â”‚
â”‚  â”‚  - SCTP (æµæ§åˆ¶ä¼ è¾“åè®®)                          â”‚  â”‚
â”‚  â”‚  - DTLS (æ•°æ®æŠ¥ä¼ è¾“å±‚å®‰å…¨)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç½‘ç»œå±‚ (Network)                                 â”‚  â”‚
â”‚  â”‚  - ICE (äº¤äº’å¼è¿æ¥å»ºç«‹)                           â”‚  â”‚
â”‚  â”‚  - STUN (NATä¼šè¯ç©¿è¶Šå·¥å…·)                        â”‚  â”‚
â”‚  â”‚  - TURN (ä¸­ç»§ç©¿è¶ŠNAT)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ“ä½œç³»ç»Ÿç½‘ç»œå±‚                          â”‚
â”‚              (UDP/TCP Socket)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ•°æ®æµå‘

```
å‘é€ç«¯æµç¨‹ï¼š
éº¦å…‹é£/æ‘„åƒå¤´
    â†“
[éŸ³è§†é¢‘é‡‡é›†] getUserMedia
    â†“
[éŸ³é¢‘å¤„ç†] å›å£°æ¶ˆé™¤ã€é™å™ª
    â†“
[è§†é¢‘å¤„ç†] åˆ†è¾¨ç‡è°ƒæ•´
    â†“
[ç¼–ç ] OpuséŸ³é¢‘ã€VP8/H.264è§†é¢‘
    â†“
[RTPæ‰“åŒ…] æ·»åŠ åºåˆ—å·ã€æ—¶é—´æˆ³
    â†“
[SRTPåŠ å¯†] åŠ å¯†åª’ä½“æ•°æ®
    â†“
[ICE/UDP] NATç©¿é€ã€å‘é€æ•°æ®åŒ…
    â†“
    ç½‘ç»œä¼ è¾“
    â†“
æ¥æ”¶ç«¯æµç¨‹ï¼š
[ICE/UDP] æ¥æ”¶æ•°æ®åŒ…
    â†“
[SRTPè§£å¯†] è§£å¯†åª’ä½“æ•°æ®
    â†“
[RTPè§£åŒ…] æå–åª’ä½“æ•°æ®
    â†“
[æŠ–åŠ¨ç¼“å†²] å¹³æ»‘ç½‘ç»œæŠ–åŠ¨
    â†“
[è§£ç ] è§£ç éŸ³è§†é¢‘
    â†“
[æ¸²æŸ“] æ’­æ”¾åˆ°æ‰¬å£°å™¨/å±å¹•
```

---

## ä¿¡ä»¤è¿‡ç¨‹è¯¦è§£

### ä»€ä¹ˆæ˜¯ä¿¡ä»¤ï¼Ÿ

**ä¿¡ä»¤ä¸æ˜¯WebRTCçš„ä¸€éƒ¨åˆ†ï¼** è¿™æ˜¯åˆå­¦è€…æœ€å®¹æ˜“å›°æƒ‘çš„åœ°æ–¹ã€‚

```
WebRTCè´Ÿè´£ï¼šåª’ä½“ä¼ è¾“ï¼ˆéŸ³è§†é¢‘æ•°æ®ï¼‰
ä¿¡ä»¤è´Ÿè´£ï¼šåè°ƒå»ºç«‹è¿æ¥ï¼ˆäº¤æ¢å…ƒæ•°æ®ï¼‰

æ¯”å–»ï¼š
- WebRTC = ç”µè¯çº¿ï¼ˆä¼ è¾“å£°éŸ³ï¼‰
- ä¿¡ä»¤ = æ‹¨å·ç³»ç»Ÿï¼ˆå»ºç«‹è¿æ¥ï¼‰
```

### ä¿¡ä»¤éœ€è¦äº¤æ¢çš„ä¿¡æ¯

```javascript
// ä¼ªä»£ç ï¼šä¿¡ä»¤éœ€è¦ä¼ é€’çš„ä¸‰ç±»ä¿¡æ¯

ä¿¡ä»¤æ¶ˆæ¯ç±»å‹ {
    // 1. SDP (Session Description Protocol)
    offer: {
        type: "offer",
        sdp: "åŒ…å«éŸ³è§†é¢‘ç¼–è§£ç å™¨ã€ç½‘ç»œä¿¡æ¯ç­‰"
    }
    
    answer: {
        type: "answer", 
        sdp: "å“åº”æ–¹çš„éŸ³è§†é¢‘ç¼–è§£ç å™¨ã€ç½‘ç»œä¿¡æ¯"
    }
    
    // 2. ICE Candidates (ç½‘ç»œå€™é€‰åœ°å€)
    candidate: {
        candidate: "candidate:... 192.168.1.100 54321 typ host",
        sdpMid: "audio",
        sdpMLineIndex: 0
    }
    
    // 3. å…¶ä»–æ§åˆ¶æ¶ˆæ¯
    hangup: { }  // æŒ‚æ–­
    busy: { }    // å¿™çº¿
}
```

### å¸¸è§ä¿¡ä»¤æ–¹æ¡ˆ

```
1. WebSocket (æœ€å¸¸ç”¨)
   å®¢æˆ·ç«¯A â†â”€ WebSocket â”€â†’ æœåŠ¡å™¨ â†â”€ WebSocket â”€â†’ å®¢æˆ·ç«¯B

2. Socket.IO
   æ›´é«˜çº§çš„WebSocketå°è£…ï¼Œè‡ªåŠ¨é™çº§

3. HTTPè½®è¯¢ï¼ˆä¸æ¨èï¼‰
   å®šæœŸå‘é€HTTPè¯·æ±‚æŸ¥è¯¢æ–°æ¶ˆæ¯

4. SIP (ä¼ä¸šçº§)
   ä¼ ç»Ÿç”µè¯ç³»ç»Ÿçš„åè®®
```

### å®Œæ•´ä¿¡ä»¤æµç¨‹

```
ç”¨æˆ·A                  ä¿¡ä»¤æœåŠ¡å™¨                ç”¨æˆ·B
  â”‚                        â”‚                       â”‚
  â”‚  1. è¿æ¥WebSocket      â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                       â”‚
  â”‚                        â”‚    1. è¿æ¥WebSocket   â”‚
  â”‚                        â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                        â”‚                       â”‚
  â”‚  2. å‘èµ·å‘¼å«           â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                       â”‚
  â”‚     {type: "call",     â”‚    2. è½¬å‘å‘¼å«è¯·æ±‚    â”‚
  â”‚      to: "userB"}      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                        â”‚                       â”‚
  â”‚                        â”‚    3. ç”¨æˆ·Bæ¥å—       â”‚
  â”‚                        â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                        â”‚                       â”‚
  â”‚  4. åˆ›å»ºOffer          â”‚                       â”‚
  â”‚  (ç”ŸæˆSDP)             â”‚                       â”‚
  â”‚                        â”‚                       â”‚
  â”‚  5. å‘é€Offer          â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                       â”‚
  â”‚   {type: "offer",      â”‚    5. è½¬å‘Offer       â”‚
  â”‚    sdp: "..."}         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                        â”‚                       â”‚
  â”‚                        â”‚    6. åˆ›å»ºAnswer      â”‚
  â”‚                        â”‚    (ç”ŸæˆSDP)          â”‚
  â”‚                        â”‚                       â”‚
  â”‚                        â”‚    7. å‘é€Answer      â”‚
  â”‚    7. è½¬å‘Answer       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   {type: "answer",    â”‚
  â”‚   {type: "answer",     â”‚    sdp: "..."}        â”‚
  â”‚    sdp: "..."}         â”‚                       â”‚
  â”‚                        â”‚                       â”‚
  â”‚  8. å‘é€ICEå€™é€‰        â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚    8. è½¬å‘å€™é€‰        â”‚
  â”‚   (å¤šæ¬¡)               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                        â”‚                       â”‚
  â”‚    9. è½¬å‘å€™é€‰         â”‚    9. å‘é€ICEå€™é€‰     â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   (å¤šæ¬¡)               â”‚    (å¤šæ¬¡)             â”‚
  â”‚                        â”‚                       â”‚
  â”‚                                                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10. P2Pè¿æ¥å»ºç«‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              (ä¸å†éœ€è¦ä¿¡ä»¤æœåŠ¡å™¨)
```

---

## NATç©¿é€æŠ€æœ¯

### ä¸ºä»€ä¹ˆéœ€è¦NATç©¿é€ï¼Ÿ

ç°å®ä¸–ç•Œçš„ç½‘ç»œç»“æ„ï¼š

```
å®¶åº­ç½‘ç»œA                                      å®¶åº­ç½‘ç»œB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”µè„‘A            â”‚                        â”‚ ç”µè„‘B            â”‚
â”‚ 192.168.1.100   â”‚                        â”‚ 192.168.1.200   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                          â”‚
         â”‚                                          â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ è·¯ç”±å™¨A   â”‚                              â”‚ è·¯ç”±å™¨B   â”‚
    â”‚ NATè®¾å¤‡   â”‚                              â”‚ NATè®¾å¤‡   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                                          â”‚
  å…¬ç½‘IP: 1.2.3.4                           å…¬ç½‘IP: 5.6.7.8
         â”‚                                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€ äº’è”ç½‘ â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚          â”‚
                    é—®é¢˜ï¼šä¸¤å°ç”µè„‘éƒ½åœ¨ç§æœ‰ç½‘ç»œå†…
                    æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹çš„ç§æœ‰IP
```

**NATï¼ˆNetwork Address Translationï¼‰** è®©å¤šå°è®¾å¤‡å…±äº«ä¸€ä¸ªå…¬ç½‘IPï¼Œä½†ä¹Ÿå¸¦æ¥äº†è¿æ¥éš¾é¢˜ã€‚

### NATçš„å››ç§ç±»å‹

```
1. å®Œå…¨é”¥å‹NAT (Full Cone NAT) - æœ€å®¹æ˜“ç©¿é€ âœ…
   å†…ç½‘ç«¯å£ â†’ å›ºå®šå…¬ç½‘ç«¯å£
   ä»»ä½•å¤–éƒ¨åœ°å€éƒ½å¯ä»¥å‘é€æ•°æ®åˆ°è¿™ä¸ªå…¬ç½‘ç«¯å£
   
   [å†…ç½‘] 192.168.1.100:5000 â†’ [å…¬ç½‘] 1.2.3.4:6000
                                    â†‘
                            ä»»ä½•IPéƒ½å¯ä»¥è®¿é—®

2. é™åˆ¶é”¥å‹NAT (Restricted Cone NAT) âš ï¸
   åªæœ‰ä¹‹å‰é€šä¿¡è¿‡çš„å¤–éƒ¨IPå¯ä»¥å‘é€æ•°æ®
   
   [å†…ç½‘] 192.168.1.100:5000 â†’ [å…¬ç½‘] 1.2.3.4:6000
                                    â†‘
                            åªæœ‰ç‰¹å®šIPå¯ä»¥è®¿é—®

3. ç«¯å£é™åˆ¶é”¥å‹NAT (Port Restricted Cone NAT) âš ï¸âš ï¸
   åªæœ‰ä¹‹å‰é€šä¿¡è¿‡çš„å¤–éƒ¨IP:ç«¯å£å¯ä»¥å‘é€æ•°æ®
   
4. å¯¹ç§°NAT (Symmetric NAT) - æœ€éš¾ç©¿é€ âŒ
   ä¸åŒçš„ç›®æ ‡åœ°å€ä¼šåˆ†é…ä¸åŒçš„å…¬ç½‘ç«¯å£
   å‡ ä¹æ— æ³•é¢„æµ‹ç«¯å£
```

### STUN - å‘ç°å…¬ç½‘åœ°å€

**STUNï¼ˆSession Traversal Utilities for NATï¼‰** æœåŠ¡å™¨å¸®ä½ å‘ç°è‡ªå·±çš„å…¬ç½‘IPå’Œç«¯å£ã€‚

```
è¿‡ç¨‹æ¼”ç¤ºï¼š

å®¢æˆ·ç«¯                         STUNæœåŠ¡å™¨
  â”‚                                â”‚
  â”‚  1. æˆ‘çš„å…¬ç½‘åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚     (ä» 192.168.1.100:5000)   â”‚
  â”‚                                â”‚
  â”‚  2. ä½ çš„å…¬ç½‘åœ°å€æ˜¯              â”‚
  â”‚     1.2.3.4:6000              â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                â”‚
  
å®¢æˆ·ç«¯ç°åœ¨çŸ¥é“äº†ï¼š
- æœ¬åœ°åœ°å€ï¼š192.168.1.100:5000
- å…¬ç½‘åœ°å€ï¼š1.2.3.4:6000
- NATç±»å‹ï¼šå¯ä»¥é€šè¿‡å¤šæ¬¡æµ‹è¯•åˆ¤æ–­
```

**STUNæœåŠ¡å™¨é…ç½®ç¤ºä¾‹ï¼š**

```javascript
// ä¼ªä»£ç ï¼šé…ç½®STUNæœåŠ¡å™¨
configuration = {
    iceServers: [
        {
            urls: "stun:stun.l.google.com:19302"  // Googleçš„å…è´¹STUNæœåŠ¡å™¨
        },
        {
            urls: "stun:stun1.example.com:3478"   // è‡ªå»ºSTUNæœåŠ¡å™¨
        }
    ]
}
```

### TURN - ä¸­ç»§è½¬å‘

å½“NATç©¿é€å¤±è´¥æ—¶ï¼Œ**TURNï¼ˆTraversal Using Relays around NATï¼‰** æœåŠ¡å™¨å……å½“ä¸­ç»§ã€‚

```
æ— æ³•ç›´è¿çš„æƒ…å†µï¼š

å®¢æˆ·ç«¯A                 TURNæœåŠ¡å™¨                 å®¢æˆ·ç«¯B
  â”‚                        â”‚                         â”‚
  â”‚  1. è¯·æ±‚åˆ†é…ä¸­ç»§åœ°å€    â”‚                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                         â”‚
  â”‚                        â”‚                         â”‚
  â”‚  2. åˆ†é…åœ°å€:           â”‚                         â”‚
  â”‚     turn.server:4000   â”‚                         â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
  â”‚                        â”‚                         â”‚
  â”‚                        â”‚  3. è¯·æ±‚åˆ†é…ä¸­ç»§åœ°å€     â”‚
  â”‚                        â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                        â”‚                         â”‚
  â”‚                        â”‚  4. åˆ†é…åœ°å€:            â”‚
  â”‚                        â”‚     turn.server:4001    â”‚
  â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                        â”‚                         â”‚
  â”‚  5. å‘é€åª’ä½“æ•°æ®        â”‚                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  6. è½¬å‘æ•°æ®            â”‚
  â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                        â”‚                         â”‚
  â”‚                        â”‚  7. å‘é€åª’ä½“æ•°æ®         â”‚
  â”‚  8. è½¬å‘æ•°æ®            â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
  â”‚                        â”‚                         â”‚

ç¼ºç‚¹ï¼š
- å¢åŠ å»¶è¿Ÿ
- æ¶ˆè€—æœåŠ¡å™¨å¸¦å®½
- éœ€è¦è®¤è¯ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰

ä¼˜ç‚¹ï¼š
- 100%æˆåŠŸç‡
- æœ€åçš„ä¿éšœ
```

**TURNæœåŠ¡å™¨é…ç½®ï¼š**

```javascript
// ä¼ªä»£ç ï¼šé…ç½®TURNæœåŠ¡å™¨
configuration = {
    iceServers: [
        {
            urls: "stun:stun.l.google.com:19302"
        },
        {
            urls: "turn:turn.example.com:3478",
            username: "user123",           // TURNéœ€è¦è®¤è¯
            credential: "password123"
        }
    ]
}
```

### NATç©¿é€æˆåŠŸç‡

```
å®é™…ç»Ÿè®¡ï¼ˆå¤§è‡´æ¯”ä¾‹ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›´æ¥P2Pè¿æ¥ (STUN)      86%   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ éœ€è¦TURNä¸­ç»§            14%   â”‚ â–ˆâ–ˆâ–ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½±å“å› ç´ ï¼š
âœ… å®¶åº­ç½‘ç»œï¼šé€šå¸¸å¯ä»¥P2P
âŒ ä¼ä¸šé˜²ç«å¢™ï¼šå¯èƒ½éœ€è¦TURN
âŒ ç§»åŠ¨ç½‘ç»œï¼šéƒ¨åˆ†è¿è¥å•†ä½¿ç”¨å¯¹ç§°NAT
```

---

## åª’ä½“åå•†ä¸SDP

### SDPæ˜¯ä»€ä¹ˆï¼Ÿ

**SDPï¼ˆSession Description Protocolï¼‰** æ˜¯ä¸€ç§æè¿°å¤šåª’ä½“ä¼šè¯çš„æ–‡æœ¬æ ¼å¼ï¼Œå‘Šè¯‰å¯¹æ–¹ï¼š
- æˆ‘æ”¯æŒå“ªäº›ç¼–è§£ç å™¨
- æˆ‘çš„ç½‘ç»œåœ°å€
- æˆ‘è¦ä¼ è¾“ä»€ä¹ˆï¼ˆéŸ³é¢‘ã€è§†é¢‘ã€æ•°æ®ï¼‰

### SDPç»“æ„è¯¦è§£

```
çœŸå®çš„SDPç¤ºä¾‹ï¼ˆå¸¦æ³¨é‡Šï¼‰ï¼š

v=0                                          â† ç‰ˆæœ¬å·
o=- 123456789 2 IN IP4 127.0.0.1            â† ä¼šè¯å‘èµ·è€…ä¿¡æ¯
s=-                                          â† ä¼šè¯åç§°
t=0 0                                        â† æ—¶é—´ï¼ˆ0 0è¡¨ç¤ºæ°¸ä¹…ï¼‰
a=group:BUNDLE audio video                   â† å¤šè·¯å¤ç”¨ï¼ˆèŠ‚çœç«¯å£ï¼‰
a=msid-semantic: WMS stream                  â† åª’ä½“æµæ ‡è¯†

â”â”â”â”â”â”â”â”â”â”â”â”â” éŸ³é¢‘éƒ¨åˆ† â”â”â”â”â”â”â”â”â”â”â”â”â”â”
m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104     â† åª’ä½“ç±»å‹ï¼šéŸ³é¢‘
c=IN IP4 0.0.0.0                            â† è¿æ¥ä¿¡æ¯ï¼ˆä¼šè¢«ICEæ›¿æ¢ï¼‰
a=rtcp:9 IN IP4 0.0.0.0                     â† RTCPç«¯å£
a=ice-ufrag:F7gI                            â† ICEç”¨æˆ·åç‰‡æ®µ
a=ice-pwd:x9cml/YzichV2+XlhiMu8g            â† ICEå¯†ç 
a=fingerprint:sha-256 49:66:12:...          â† DTLSè¯ä¹¦æŒ‡çº¹ï¼ˆå®‰å…¨ï¼‰
a=setup:actpass                             â† DTLSè§’è‰²åå•†
a=mid:audio                                 â† åª’ä½“ID
a=sendrecv                                  â† å‘é€+æ¥æ”¶æ¨¡å¼
a=rtcp-mux                                  â† RTPå’ŒRTCPå¤ç”¨åŒä¸€ç«¯å£

-- æ”¯æŒçš„éŸ³é¢‘ç¼–è§£ç å™¨ --
a=rtpmap:111 opus/48000/2                   â† Opusç¼–ç ï¼Œ48kHzï¼Œç«‹ä½“å£°
a=fmtp:111 minptime=10;useinbandfec=1       â† Opuså‚æ•°
a=rtpmap:103 ISAC/16000                     â† ISACç¼–ç 
a=rtpmap:104 ISAC/32000

â”â”â”â”â”â”â”â”â”â”â”â”â” è§†é¢‘éƒ¨åˆ† â”â”â”â”â”â”â”â”â”â”â”â”â”â”
m=video 9 UDP/TLS/RTP/SAVPF 96 97 98        â† åª’ä½“ç±»å‹ï¼šè§†é¢‘
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=ice-ufrag:F7gI
a=ice-pwd:x9cml/YzichV2+XlhiMu8g
a=fingerprint:sha-256 49:66:12:...
a=setup:actpass
a=mid:video
a=sendrecv
a=rtcp-mux

-- æ”¯æŒçš„è§†é¢‘ç¼–è§£ç å™¨ --
a=rtpmap:96 VP8/90000                       â† VP8ç¼–ç ï¼Œ90kHzæ—¶é’Ÿ
a=rtcp-fb:96 nack                           â† æ”¯æŒNACKï¼ˆé‡ä¼ è¯·æ±‚ï¼‰
a=rtcp-fb:96 nack pli                       â† æ”¯æŒå…³é”®å¸§è¯·æ±‚
a=rtcp-fb:96 ccm fir                        â† æ”¯æŒå®Œæ•´å¸§è¯·æ±‚
a=rtcp-fb:96 goog-remb                      â† Googleå¸¦å®½ä¼°è®¡

a=rtpmap:97 H264/90000                      â† H.264ç¼–ç 
a=fmtp:97 profile-level-id=42e01f           â† H.264 Baseline Profile
a=rtcp-fb:97 nack
a=rtcp-fb:97 nack pli

a=rtpmap:98 rtx/90000                       â† RTXé‡ä¼ æµ
a=fmtp:98 apt=96                            â† å…³è”åˆ°VP8

-- è§†é¢‘é™åˆ¶ --
a=max-message-size:262144                   â† æœ€å¤§æ¶ˆæ¯å¤§å°
```

### SDPåå•†è¿‡ç¨‹

```
Offer-Answeræ¨¡å‹ï¼š

å‘èµ·æ–¹ï¼ˆOffererï¼‰                æ¥æ”¶æ–¹ï¼ˆAnswererï¼‰
     â”‚                                 â”‚
     â”‚ 1. åˆ›å»ºOffer SDP                â”‚
     â”‚    æˆ‘æ”¯æŒï¼š                      â”‚
     â”‚    - VP8, H.264                 â”‚
     â”‚    - Opus, PCMU                 â”‚
     â”‚    - åˆ†è¾¨ç‡æœ€é«˜1080p            â”‚
     â”‚                                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€ Offer SDP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                                 â”‚
     â”‚                        2. åˆ†æOffer
     â”‚                           æˆ‘æ”¯æŒï¼š
     â”‚                           - VP8 âœ…
     â”‚                           - H.264 âœ…
     â”‚                           - Opus âœ…
     â”‚                           
     â”‚                        3. åˆ›å»ºAnswer SDP
     â”‚                           ç¡®è®¤ä½¿ç”¨ï¼š
     â”‚                           - VP8
     â”‚                           - Opus
     â”‚                                 â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€ Answer SDP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                 â”‚
     â”‚ 4. åŒæ–¹åå•†å®Œæˆ                  â”‚
     â”‚    æœ€ç»ˆä½¿ç”¨ï¼šVP8 + Opus          â”‚
     â”‚                                 â”‚
     â””â”€â”€â”€â”€ å¼€å§‹ä¼ è¾“åª’ä½“æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–è§£ç å™¨åå•†

```javascript
// ä¼ªä»£ç ï¼šç¼–è§£ç å™¨ä¼˜å…ˆçº§

OfferSDP = {
    audio: ["Opus", "PCMU", "PCMA"],      // æŒ‰ä¼˜å…ˆçº§æ’åˆ—
    video: ["VP9", "VP8", "H.264"]
}

AnswerSDP = {
    audio: ["Opus"],          // é€‰æ‹©åŒæ–¹éƒ½æ”¯æŒçš„æœ€ä¼˜é€‰é¡¹
    video: ["VP8"]
}

æœ€ç»ˆç»“æœï¼š
âœ… éŸ³é¢‘ï¼šOpusï¼ˆé«˜è´¨é‡ã€ä½å»¶è¿Ÿï¼‰
âœ… è§†é¢‘ï¼šVP8ï¼ˆå¼€æºã€å¹¿æ³›æ”¯æŒï¼‰
```

---

## ICEå€™é€‰è€…æœºåˆ¶

### ICEæ˜¯ä»€ä¹ˆï¼Ÿ

**ICEï¼ˆInteractive Connectivity Establishmentï¼‰** æ˜¯ä¸€ç§æ¡†æ¶ï¼Œç”¨äºæ‰¾åˆ°ä¸¤ä¸ªå¯¹ç­‰ç«¯ä¹‹é—´æœ€ä½³çš„ç½‘ç»œè·¯å¾„ã€‚

### ICEå€™é€‰è€…ç±»å‹

```
1. Hostå€™é€‰è€…ï¼ˆæœ¬åœ°åœ°å€ï¼‰
   candidate:1 1 UDP 2130706431 192.168.1.100 54321 typ host
                                 â””â”€ æœ¬åœ°IP â”€â”˜  â””ç«¯å£â”˜
   
   ç‰¹ç‚¹ï¼š
   - ä¼˜å…ˆçº§æœ€é«˜
   - å»¶è¿Ÿæœ€ä½
   - åªåœ¨åŒä¸€å±€åŸŸç½‘æœ‰æ•ˆ

2. Server Reflexiveå€™é€‰è€…ï¼ˆé€šè¿‡STUNå‘ç°çš„å…¬ç½‘åœ°å€ï¼‰
   candidate:2 1 UDP 1694498815 1.2.3.4 54321 typ srflx raddr 192.168.1.100 rport 54321
                                 â””å…¬ç½‘IPâ”˜              â””â”€ æœ¬åœ°åœ°å€ â”€â”˜
   
   ç‰¹ç‚¹ï¼š
   - å¯ä»¥ç©¿è¶ŠNAT
   - é€‚ç”¨äºP2Pè¿æ¥
   - éœ€è¦STUNæœåŠ¡å™¨

3. Relayå€™é€‰è€…ï¼ˆé€šè¿‡TURNä¸­ç»§ï¼‰
   candidate:3 1 UDP 16777215 10.20.30.40 54321 typ relay raddr 1.2.3.4 rport 54321
                               â””TURNæœåŠ¡å™¨â”˜             â””â”€ å…¬ç½‘åœ°å€ â”€â”˜
   
   ç‰¹ç‚¹ï¼š
   - 100%æˆåŠŸç‡
   - ä¼˜å…ˆçº§æœ€ä½ï¼ˆæœ€åæ‰‹æ®µï¼‰
   - æ¶ˆè€—æœåŠ¡å™¨èµ„æº
```

### ICEå€™é€‰è€…æ”¶é›†è¿‡ç¨‹

```
æœ¬åœ°æ”¶é›†å€™é€‰è€…ï¼š

1. æ”¶é›†æ‰€æœ‰æœ¬åœ°ç½‘ç»œæ¥å£
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ä»¥å¤ªç½‘: 192.168.1.100   â”‚ â†’ Hostå€™é€‰è€…1
   â”‚ WiFi:   192.168.2.50    â”‚ â†’ Hostå€™é€‰è€…2
   â”‚ VPN:    10.8.0.5        â”‚ â†’ Hostå€™é€‰è€…3
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. é€šè¿‡STUNè·å–å…¬ç½‘åœ°å€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ STUNæŸ¥è¯¢ â†’ 1.2.3.4:6000 â”‚ â†’ Srflxå€™é€‰è€…1
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. é€šè¿‡TURNè·å–ä¸­ç»§åœ°å€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TURNåˆ†é… â†’ turn:4000    â”‚ â†’ Relayå€™é€‰è€…1
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ€ç»ˆæ”¶é›†åˆ°ï¼š
[Host1, Host2, Host3, Srflx1, Relay1]
```

### ICEè¿é€šæ€§æ£€æŸ¥

åŒæ–¹äº¤æ¢å€™é€‰è€…åï¼Œå¼€å§‹é…å¯¹æµ‹è¯•ï¼š

```
å¯¹ç­‰ç«¯Açš„å€™é€‰è€…            å¯¹ç­‰ç«¯Bçš„å€™é€‰è€…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A1: 192.168.1.100â”‚       â”‚ B1: 192.168.2.200â”‚
â”‚ A2: 1.2.3.4:6000 â”‚       â”‚ B2: 5.6.7.8:7000 â”‚
â”‚ A3: turn:4000    â”‚       â”‚ B3: turn:5000    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…å¯¹ç»„åˆï¼ˆç¬›å¡å°”ç§¯ï¼‰ï¼š
(A1, B1), (A1, B2), (A1, B3),
(A2, B1), (A2, B2), (A2, B3),  â† 9ç§å¯èƒ½çš„ç»„åˆ
(A3, B1), (A3, B2), (A3, B3)

æŒ‰ä¼˜å…ˆçº§æµ‹è¯•ï¼š
1. (A1, B1) - æœ¬åœ°å¯¹æœ¬åœ°     âŒ ä¸åŒç½‘ç»œï¼Œå¤±è´¥
2. (A2, B2) - å…¬ç½‘å¯¹å…¬ç½‘     âœ… æˆåŠŸï¼å»¶è¿Ÿ50ms
3. (A2, B3) - å…¬ç½‘å¯¹ä¸­ç»§     âœ… æˆåŠŸï¼å»¶è¿Ÿ120ms
4. ...

é€‰æ‹©æœ€ä½³è·¯å¾„ï¼š
âœ… ä½¿ç”¨ (A2, B2) - å»¶è¿Ÿæœ€ä½
```

### å®Œæ•´çš„ICEæµç¨‹

```
æ—¶é—´çº¿ï¼š

T=0s    åˆ›å»ºPeerConnection
        â†“
T=0.1s  æ”¶é›†ICEå€™é€‰è€…å¼€å§‹
        â”œâ”€ å‘ç°Hostå€™é€‰è€…ï¼ˆç«‹å³ï¼‰
        â”œâ”€ STUNæŸ¥è¯¢ï¼ˆ100msï¼‰
        â””â”€ TURNåˆ†é…ï¼ˆ200msï¼‰
        â†“
T=0.1s  onicecandidateäº‹ä»¶è§¦å‘
        å‘é€ç¬¬ä¸€ä¸ªå€™é€‰è€…ï¼ˆHostï¼‰
        â†“
T=0.2s  onicecandidateäº‹ä»¶è§¦å‘
        å‘é€ç¬¬äºŒä¸ªå€™é€‰è€…ï¼ˆSrflxï¼‰
        â†“
T=0.3s  onicecandidateäº‹ä»¶è§¦å‘
        å‘é€ç¬¬ä¸‰ä¸ªå€™é€‰è€…ï¼ˆRelayï¼‰
        â†“
T=0.3s  onicecandidateäº‹ä»¶ (null)
        å€™é€‰è€…æ”¶é›†å®Œæˆ
        â†“
T=0.5s  æ”¶åˆ°è¿œç«¯å€™é€‰è€…
        å¼€å§‹è¿é€šæ€§æ£€æŸ¥
        â†“
T=0.6s  ICEè¿æ¥çŠ¶æ€: checking
        â†“
T=0.8s  ICEè¿æ¥çŠ¶æ€: connected âœ…
        æ‰¾åˆ°å¯ç”¨è·¯å¾„
        â†“
T=1.0s  ICEè¿æ¥çŠ¶æ€: completed
        æ‰€æœ‰æ£€æŸ¥å®Œæˆ
```

---

## æ•°æ®ä¼ è¾“å±‚

### RTP/RTCPåè®®

**RTPï¼ˆReal-time Transport Protocolï¼‰** è´Ÿè´£ä¼ è¾“å®æ—¶åª’ä½“æ•°æ®ã€‚

```
RTPåŒ…ç»“æ„ï¼š

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
â”Œâ”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”¬â”€â”
â”‚V=2â”‚Pâ”‚Xâ”‚  CC   â”‚Mâ”‚     PT      â”‚       Sequence Number         â”‚ å¤´éƒ¨
â”œâ”€â”€â”€â”´â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ (12å­—èŠ‚)
â”‚                           Timestamp                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             SSRC                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         Payload Data                           â”‚ è½½è·
â”‚                            (å˜é•¿)                              â”‚ (éŸ³è§†é¢‘)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­—æ®µè¯´æ˜ï¼š
V  (Version):         ç‰ˆæœ¬å·ï¼Œå›ºå®šä¸º2
P  (Padding):         æ˜¯å¦æœ‰å¡«å……
X  (Extension):       æ˜¯å¦æœ‰æ‰©å±•å¤´
CC (CSRC Count):      CSRCæ ‡è¯†ç¬¦æ•°é‡
M  (Marker):          æ ‡è®°ä½ï¼ˆå¦‚è§†é¢‘å¸§ç»“æŸï¼‰
PT (Payload Type):    è½½è·ç±»å‹ï¼ˆç¼–ç æ ¼å¼ï¼‰
Sequence Number:      åºåˆ—å·ï¼ˆæ£€æµ‹ä¸¢åŒ…ï¼‰
Timestamp:            æ—¶é—´æˆ³ï¼ˆåŒæ­¥ã€æŠ–åŠ¨è®¡ç®—ï¼‰
SSRC:                 åŒæ­¥æºæ ‡è¯†ç¬¦ï¼ˆåŒºåˆ†ä¸åŒæµï¼‰
```

**RTCPï¼ˆRTP Control Protocolï¼‰** è´Ÿè´£ä¼ è¾“æ§åˆ¶ä¿¡æ¯ï¼š

```
RTCPåŒ…ç±»å‹ï¼š

1. Sender Report (SR) - å‘é€æ–¹æŠ¥å‘Š
   æ¯éš”ä¸€æ®µæ—¶é—´å‘é€ï¼š
   - å·²å‘é€åŒ…æ•°é‡
   - å·²å‘é€å­—èŠ‚æ•°
   - æ—¶é—´æˆ³

2. Receiver Report (RR) - æ¥æ”¶æ–¹æŠ¥å‘Š
   åé¦ˆç»™å‘é€æ–¹ï¼š
   - ä¸¢åŒ…ç‡ï¼š3.2%
   - æŠ–åŠ¨ï¼š15ms
   - å¾€è¿”æ—¶å»¶ï¼ˆRTTï¼‰ï¼š50ms

3. Source Description (SDES)
   æè¿°æºä¿¡æ¯ï¼ˆç”¨æˆ·åç­‰ï¼‰

4. BYE - ç¦»å¼€é€šçŸ¥
   ç»“æŸä¼šè¯

5. APP - åº”ç”¨è‡ªå®šä¹‰
```

### SRTPåŠ å¯†

**SRTPï¼ˆSecure RTPï¼‰** å¯¹RTPæ•°æ®è¿›è¡ŒåŠ å¯†ã€‚

```
RTP â†’ SRTPåŠ å¯†è¿‡ç¨‹ï¼š

æ˜æ–‡RTPåŒ…
    â†“
[1] ä½¿ç”¨DTLSåå•†å¯†é’¥
    Master Key: 128-bit AESå¯†é’¥
    Master Salt: 112-bitç›å€¼
    â†“
[2] ä¸ºæ¯ä¸ªåŒ…ç”Ÿæˆå¯†é’¥æµ
    Key = PRF(Master Key, SSRC, Packet Index, Salt)
    â†“
[3] åŠ å¯†è½½è·
    Encrypted Payload = Payload XOR Key
    â†“
[4] æ·»åŠ è®¤è¯æ ‡ç­¾ï¼ˆé˜²ç¯¡æ”¹ï¼‰
    Auth Tag = HMAC-SHA1(Packet)
    â†“
SRTPåŒ…ï¼ˆåŠ å¯†+è®¤è¯ï¼‰

å®‰å…¨ä¿éšœï¼š
âœ… æœºå¯†æ€§ï¼šæ•°æ®åŠ å¯†ï¼Œæ— æ³•çªƒå¬
âœ… å®Œæ•´æ€§ï¼šè®¤è¯æ ‡ç­¾ï¼Œé˜²æ­¢ç¯¡æ”¹
âœ… é‡æ”¾ä¿æŠ¤ï¼šåºåˆ—å·æ£€æŸ¥
```

### DataChannelä¼ è¾“

**RTCDataChannel** ä½¿ç”¨ **SCTP over DTLS** ä¼ è¾“ä»»æ„æ•°æ®ã€‚

```
åè®®æ ˆï¼š

åº”ç”¨æ•°æ®ï¼ˆæ–‡æœ¬ã€æ–‡ä»¶ç­‰ï¼‰
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      SCTP         â”‚ â† æµæ§åˆ¶ä¼ è¾“åè®®
â”‚  - å¯é /ä¸å¯é     â”‚
â”‚  - æœ‰åº/æ— åº      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DTLS         â”‚ â† åŠ å¯†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      UDP          â”‚ â† åº•å±‚ä¼ è¾“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DataChannelé…ç½®é€‰é¡¹ï¼š**

```javascript
// ä¼ªä»£ç ï¼šåˆ›å»ºDataChannel

dataChannel = peerConnection.createDataChannel("myChannel", {
    ordered: true,          // æ˜¯å¦ä¿è¯é¡ºåº
    maxRetransmits: 3,      // æœ€å¤§é‡ä¼ æ¬¡æ•°ï¼ˆä¸å¯é æ¨¡å¼ï¼‰
    maxPacketLifeTime: 3000 // åŒ…æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
});

ä½¿ç”¨åœºæ™¯ï¼š
1. ordered=true, maxRetransmits=null
   â†’ å¯é æœ‰åºï¼ˆç±»ä¼¼TCPï¼‰
   é€‚åˆï¼šæ–‡ä»¶ä¼ è¾“ã€èŠå¤©æ¶ˆæ¯

2. ordered=false, maxPacketLifeTime=100
   â†’ ä¸å¯é æ— åºï¼Œ100msè¶…æ—¶
   é€‚åˆï¼šå®æ—¶æ¸¸æˆä½ç½®æ›´æ–°

3. ordered=false, maxRetransmits=0
   â†’ ä¸å¯é æ— åºï¼Œä¸é‡ä¼ 
   é€‚åˆï¼šé¼ æ ‡ä½ç½®ã€å®æ—¶çŠ¶æ€
```

---

## å®Œæ•´é€šä¿¡æµç¨‹

### å…¸å‹çš„1å¯¹1è§†é¢‘é€šè¯æµç¨‹

```javascript
// ä¼ªä»£ç ï¼šå®Œæ•´çš„WebRTCé€šè¯æµç¨‹

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ– â•â•â•â•â•â•â•â•â•â•â•â•

// Aç«¯å’ŒBç«¯éƒ½æ‰§è¡Œ
function initialize() {
    // 1. é…ç½®ICEæœåŠ¡å™¨
    config = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { 
                urls: "turn:turn.example.com:3478",
                username: "user",
                credential: "pass"
            }
        ]
    };
    
    // 2. åˆ›å»ºPeerConnection
    pc = new RTCPeerConnection(config);
    
    // 3. è·å–æœ¬åœ°åª’ä½“æµ
    localStream = getUserMedia({
        video: { width: 1280, height: 720 },
        audio: true
    });
    
    // 4. æ·»åŠ æœ¬åœ°æµåˆ°è¿æ¥
    for (track in localStream.getTracks()) {
        pc.addTrack(track, localStream);
    }
    
    // 5. æ˜¾ç¤ºæœ¬åœ°è§†é¢‘
    localVideoElement.srcObject = localStream;
}

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬äºŒé˜¶æ®µï¼šAç«¯å‘èµ·å‘¼å« â•â•â•â•â•â•â•â•â•â•â•â•

// Aç«¯ï¼šåˆ›å»ºOffer
async function createOffer() {
    // 1. åˆ›å»ºSDP Offer
    offer = await pc.createOffer({
        offerToReceiveVideo: true,
        offerToReceiveAudio: true
    });
    
    // 2. è®¾ç½®æœ¬åœ°æè¿°
    await pc.setLocalDescription(offer);
    
    // 3. é€šè¿‡ä¿¡ä»¤å‘é€ç»™Bç«¯
    signalingChannel.send({
        type: "offer",
        sdp: offer.sdp,
        to: "userB"
    });
}

// è®¾ç½®ICEå€™é€‰è€…å¤„ç†
pc.onicecandidate = (event) => {
    if (event.candidate) {
        // å‘é€å€™é€‰è€…ç»™å¯¹æ–¹
        signalingChannel.send({
            type: "candidate",
            candidate: event.candidate,
            to: "userB"
        });
    }
};

// æ¥æ”¶è¿œç«¯æµ
pc.ontrack = (event) => {
    remoteVideoElement.srcObject = event.streams[0];
};

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬ä¸‰é˜¶æ®µï¼šBç«¯æ¥æ”¶å¹¶åº”ç­” â•â•â•â•â•â•â•â•â•â•â•â•

// Bç«¯ï¼šæ¥æ”¶Offerå¹¶åˆ›å»ºAnswer
async function handleOffer(offer) {
    // 1. è®¾ç½®è¿œç«¯æè¿°
    await pc.setRemoteDescription(offer);
    
    // 2. åˆ›å»ºSDP Answer
    answer = await pc.createAnswer();
    
    // 3. è®¾ç½®æœ¬åœ°æè¿°
    await pc.setLocalDescription(answer);
    
    // 4. é€šè¿‡ä¿¡ä»¤å‘é€ç»™Aç«¯
    signalingChannel.send({
        type: "answer",
        sdp: answer.sdp,
        to: "userA"
    });
}

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬å››é˜¶æ®µï¼šäº¤æ¢ICEå€™é€‰è€… â•â•â•â•â•â•â•â•â•â•â•â•

// Aç«¯å’ŒBç«¯éƒ½æ‰§è¡Œ
async function handleCandidate(candidate) {
    await pc.addIceCandidate(candidate);
}

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬äº”é˜¶æ®µï¼šè¿æ¥å»ºç«‹ â•â•â•â•â•â•â•â•â•â•â•â•

// ç›‘å¬è¿æ¥çŠ¶æ€
pc.oniceconnectionstatechange = () => {
    console.log("ICEçŠ¶æ€:", pc.iceConnectionState);
    
    switch(pc.iceConnectionState) {
        case "checking":
            console.log("ğŸ” æ­£åœ¨æ£€æŸ¥è¿æ¥...");
            break;
        case "connected":
            console.log("âœ… è¿æ¥æˆåŠŸï¼");
            break;
        case "completed":
            console.log("âœ… è¿æ¥å®Œæˆï¼");
            break;
        case "failed":
            console.log("âŒ è¿æ¥å¤±è´¥ï¼");
            // å¯èƒ½éœ€è¦é‡æ–°åå•†æˆ–ä½¿ç”¨TURN
            break;
        case "disconnected":
            console.log("âš ï¸ è¿æ¥æ–­å¼€ï¼");
            break;
        case "closed":
            console.log("ğŸ”š è¿æ¥å…³é—­ï¼");
            break;
    }
};

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬å…­é˜¶æ®µï¼šé€šè¯ä¸­ â•â•â•â•â•â•â•â•â•â•â•â•

// åª’ä½“æ•°æ®é€šè¿‡P2Pè¿æ¥ç›´æ¥ä¼ è¾“
// Aç«¯ â†â”€â”€â”€ RTP/SRTP (åŠ å¯†) â”€â”€â”€â†’ Bç«¯

// å¯ä»¥åŠ¨æ€è°ƒæ•´ï¼š
function muteAudio() {
    localStream.getAudioTracks()[0].enabled = false;
}

function disableVideo() {
    localStream.getVideoTracks()[0].enabled = false;
}

function changeResolution() {
    videoTrack = localStream.getVideoTracks()[0];
    videoTrack.applyConstraints({
        width: 640,
        height: 480
    });
}

â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬ä¸ƒé˜¶æ®µï¼šç»“æŸé€šè¯ â•â•â•â•â•â•â•â•â•â•â•â•

function hangup() {
    // 1. åœæ­¢æœ¬åœ°æµ
    localStream.getTracks().forEach(track => track.stop());
    
    // 2. å…³é—­è¿æ¥
    pc.close();
    
    // 3. é€šçŸ¥å¯¹æ–¹
    signalingChannel.send({
        type: "hangup",
        to: "userB"
    });
}
```

### æ—¶åºå›¾æ€»ç»“

```
ç”¨æˆ·A                ä¿¡ä»¤æœåŠ¡å™¨              ç”¨æˆ·B
  â”‚                      â”‚                      â”‚
  â”‚ â‘  åˆå§‹åŒ–              â”‚      â‘  åˆå§‹åŒ–        â”‚
  â”‚ - è·å–æ‘„åƒå¤´          â”‚      - è·å–æ‘„åƒå¤´    â”‚
  â”‚ - åˆ›å»ºPeerConnection  â”‚      - åˆ›å»ºPC       â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘¡ å‘èµ·å‘¼å«           â”‚                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                      â”‚      â‘¢ æ¥å—å‘¼å«      â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘£ åˆ›å»ºOffer          â”‚                      â”‚
  â”‚ setLocalDescription  â”‚                      â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘¤ å‘é€Offer          â”‚                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                      â”‚      â‘¥ æ”¶åˆ°Offer     â”‚
  â”‚                      â”‚      setRemoteDesc   â”‚
  â”‚                      â”‚      â‘¦ åˆ›å»ºAnswer    â”‚
  â”‚                      â”‚      setLocalDesc    â”‚
  â”‚                      â”‚                      â”‚
  â”‚      â‘§ æ”¶åˆ°Answer    â”‚      â‘¨ å‘é€Answer    â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ setRemoteDescription â”‚                      â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘© ICEå€™é€‰è€…æ”¶é›†      â”‚      â‘© ICEå€™é€‰è€…æ”¶é›† â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚
  â”‚ â”œâ”€ candidate 1       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚ â”œâ”€ candidate 2       â”‚                      â”‚
  â”‚ â””â”€ candidate 3       â”‚                      â”‚
  â”‚                      â”‚                      â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚  â”œâ”€ candidate 1      â”‚
  â”‚                      â”‚  â”œâ”€ candidate 2      â”‚
  â”‚                      â”‚  â””â”€ candidate 3      â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘ª è¿é€šæ€§æ£€æŸ¥          â”‚                      â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
  â”‚     STUN Binding Request/Response          â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘« è¿æ¥å»ºç«‹ âœ…         â”‚                      â”‚
  â”‚â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º  â”‚
  â”‚        P2P åŠ å¯†åª’ä½“æµ (RTP/SRTP)           â”‚
  â”‚        ğŸ¥ è§†é¢‘ + ğŸ”Š éŸ³é¢‘                    â”‚
  â”‚                      â”‚                      â”‚
  â”‚                      â”‚                      â”‚
  â”‚ â‘¬ æŒ‚æ–­               â”‚                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚ å…³é—­è¿æ¥             â”‚      å…³é—­è¿æ¥        â”‚
  â”‚                      â”‚                      â”‚
```

---

## å®æˆ˜åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šè§†é¢‘ä¼šè®®

```
æŠ€æœ¯è¦ç‚¹ï¼š

1. å¤šæ–¹è¿æ¥æ¶æ„
   
   æ–¹æ¡ˆAï¼šMeshï¼ˆç½‘çŠ¶ï¼‰- æ¯ä¸ªäººè¿æ¥æ‰€æœ‰äºº
   â”Œâ”€â”€â”€â”€â”€â”
   â”‚ A   â”‚â”€â”€â”€â”€â”
   â””â”€â”€â”¬â”€â”€â”˜    â”‚
      â”‚    â”Œâ”€â”€â”´â”€â”€â”
      â””â”€â”€â”€â”€â”¤  B  â”‚
           â””â”€â”€â”¬â”€â”€â”˜
              â”‚
           â”Œâ”€â”€â”´â”€â”€â”
           â”‚  C  â”‚
           â””â”€â”€â”€â”€â”€â”˜
   
   ä¼˜ç‚¹ï¼šä½å»¶è¿Ÿã€æ— æœåŠ¡å™¨æˆæœ¬
   ç¼ºç‚¹ï¼šå¸¦å®½æ¶ˆè€—å¤§ï¼ˆ3äºº=6æ¡è¿æ¥ï¼Œ4äºº=12æ¡ï¼‰
   é€‚åˆï¼š3-4äººå°ä¼šè®®

   æ–¹æ¡ˆBï¼šSFUï¼ˆé€‰æ‹©æ€§è½¬å‘ï¼‰- æœåŠ¡å™¨è½¬å‘
   â”Œâ”€â”€â”€â”€â”€â”
   â”‚  A  â”‚â”€â”€â”€â”€â”€â”
   â””â”€â”€â”€â”€â”€â”˜     â”‚
               â†“
   â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
   â”‚  B  â”‚â†â†’â”‚ SFU â”‚
   â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
               â†‘
   â”Œâ”€â”€â”€â”€â”€â”    â”‚
   â”‚  C  â”‚â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”˜
   
   ä¼˜ç‚¹ï¼šèŠ‚çœå®¢æˆ·ç«¯å¸¦å®½
   ç¼ºç‚¹ï¼šéœ€è¦æœåŠ¡å™¨
   é€‚åˆï¼š5äººä»¥ä¸Šä¼šè®®

   æ–¹æ¡ˆCï¼šMCUï¼ˆå¤šç‚¹æ§åˆ¶ï¼‰- æœåŠ¡å™¨æ··æµ
   â”Œâ”€â”€â”€â”€â”€â”
   â”‚  A  â”‚â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â””â”€â”€â”€â”€â”€â”˜ â”‚   â”‚    MCU      â”‚
   â”Œâ”€â”€â”€â”€â”€â” â”œâ”€â”€â†’â”‚ - è§£ç æ‰€æœ‰æµ â”‚â”€â†’ æ··åˆåçš„å•ä¸€æµ
   â”‚  B  â”‚â”€â”¤   â”‚ - æ··åˆè§†é¢‘   â”‚
   â””â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ - æ··åˆéŸ³é¢‘   â”‚
   â”Œâ”€â”€â”€â”€â”€â” â”‚   â”‚ - é‡æ–°ç¼–ç    â”‚
   â”‚  C  â”‚â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”˜
   
   ä¼˜ç‚¹ï¼šå®¢æˆ·ç«¯å¸¦å®½æœ€çœ
   ç¼ºç‚¹ï¼šæœåŠ¡å™¨æˆæœ¬é«˜ã€å»¶è¿Ÿå¢åŠ 
   é€‚åˆï¼šå¤§å‹ä¼šè®®ã€å½•åˆ¶

2. å±å¹•å…±äº«å®ç°

function shareScreen() {
    screenStream = getDisplayMedia({
        video: {
            cursor: "always"  // æ˜¾ç¤ºé¼ æ ‡
        }
    });
    
    // æ›¿æ¢è§†é¢‘è½¨é“
    videoTrack = screenStream.getVideoTracks()[0];
    sender = pc.getSenders().find(s => s.track.kind === 'video');
    sender.replaceTrack(videoTrack);
}

3. è™šæ‹ŸèƒŒæ™¯

function applyVirtualBackground() {
    // ä½¿ç”¨Canvaså¤„ç†æ¯ä¸€å¸§
    videoTrack = localStream.getVideoTracks()[0];
    processor = new MediaStreamTrackProcessor(videoTrack);
    
    reader = processor.readable.getReader();
    
    while (true) {
        frame = await reader.read();
        
        // èƒŒæ™¯åˆ†å‰²ï¼ˆä½¿ç”¨MLæ¨¡å‹ï¼‰
        mask = segmentPerson(frame);
        
        // æ›¿æ¢èƒŒæ™¯
        newFrame = compositeBackground(frame, mask, backgroundImage);
        
        // è¾“å‡ºå¤„ç†åçš„å¸§
        outputTrack.write(newFrame);
    }
}
```

### åœºæ™¯2ï¼šåœ¨çº¿æ•™è‚²

```
éœ€æ±‚åˆ†æï¼š
- è€å¸ˆé«˜æ¸…è§†é¢‘ï¼ˆ1080pï¼‰
- å­¦ç”Ÿä½æ¸…è§†é¢‘ï¼ˆ360pèŠ‚çœå¸¦å®½ï¼‰
- è¯¾ä»¶å…±äº«ï¼ˆå±å¹•ï¼‰
- ä¸¾æ‰‹åŠŸèƒ½ï¼ˆDataChannelï¼‰
- å½•åˆ¶å›æ”¾

å®ç°æ–¹æ¡ˆï¼š

// æ•™å¸ˆç«¯é…ç½®
teacherPC = new RTCPeerConnection();

// é«˜æ¸…è§†é¢‘
teacherStream = getUserMedia({
    video: {
        width: 1920,
        height: 1080,
        frameRate: 30
    },
    audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
    }
});

// å­¦ç”Ÿç«¯é…ç½®
studentPC = new RTCPeerConnection();

studentStream = getUserMedia({
    video: {
        width: 640,
        height: 360,
        frameRate: 15  // é™ä½å¸§ç‡èŠ‚çœå¸¦å®½
    },
    audio: true
});

// ä¸¾æ‰‹åŠŸèƒ½
raiseHandChannel = pc.createDataChannel("raiseHand");

function raiseHand() {
    raiseHandChannel.send(JSON.stringify({
        action: "raise_hand",
        studentId: myId,
        timestamp: Date.now()
    }));
}

// ç™½æ¿åŠŸèƒ½
whiteboardChannel = pc.createDataChannel("whiteboard");

function drawOnWhiteboard(x, y, color) {
    whiteboardChannel.send(JSON.stringify({
        action: "draw",
        x: x,
        y: y,
        color: color
    }));
}
```

### åœºæ™¯3ï¼šè¿œç¨‹ç›‘æ§

```
ç‰¹ç‚¹ï¼š
- å•å‘è§†é¢‘æµï¼ˆç›‘æ§â†’è§‚çœ‹è€…ï¼‰
- ä½å»¶è¿Ÿè¦æ±‚
- å¯èƒ½å¤šäººè§‚çœ‹
- éœ€è¦å½•åˆ¶

é…ç½®ï¼š

// ç›‘æ§ç«¯ï¼ˆåªå‘é€ï¼‰
cameraStream = getUserMedia({ video: true, audio: false });

pc = new RTCPeerConnection();
pc.addTrack(cameraStream.getVideoTracks()[0]);

// åªå‘é€ï¼Œä¸æ¥æ”¶
offer = await pc.createOffer({
    offerToReceiveVideo: false,
    offerToReceiveAudio: false
});

// è§‚çœ‹ç«¯ï¼ˆåªæ¥æ”¶ï¼‰
pc = new RTCPeerConnection();

pc.ontrack = (event) => {
    videoElement.srcObject = event.streams[0];
};

// å½•åˆ¶åŠŸèƒ½
recorder = new MediaRecorder(remoteStream);

recorder.ondataavailable = (event) => {
    chunks.push(event.data);
};

recorder.start();
```

### åœºæ™¯4ï¼šå®æ—¶æ¸¸æˆ

```
éœ€æ±‚ï¼š
- æä½å»¶è¿Ÿï¼ˆ<50msï¼‰
- ä¸å¯é ä¼ è¾“ï¼ˆä¸¢åŒ…å¯æ¥å—ï¼‰
- é«˜é¢‘ç‡çŠ¶æ€æ›´æ–°

é…ç½®ï¼š

// æ¸¸æˆçŠ¶æ€é€šé“
gameChannel = pc.createDataChannel("game", {
    ordered: false,           // ä¸ä¿è¯é¡ºåº
    maxRetransmits: 0,       // ä¸é‡ä¼ 
    maxPacketLifeTime: 50    // 50msè¶…æ—¶
});

// å‘é€ç©å®¶ä½ç½®
function sendPosition(x, y) {
    gameChannel.send(JSON.stringify({
        type: "position",
        x: x,
        y: y,
        timestamp: performance.now()
    }));
}

// 30æ¬¡/ç§’æ›´æ–°
setInterval(() => {
    sendPosition(player.x, player.y);
}, 33);  // 1000ms / 30 â‰ˆ 33ms

// æ¥æ”¶å¯¹æ‰‹ä½ç½®
gameChannel.onmessage = (event) => {
    data = JSON.parse(event.data);
    
    if (data.type === "position") {
        // æ’å€¼å¤„ç†ï¼Œå¹³æ»‘ç§»åŠ¨
        opponent.setTargetPosition(data.x, data.y);
    }
};
```

---

## æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜æ’æŸ¥

### å¸¦å®½è‡ªé€‚åº”

WebRTCå†…ç½®å¸¦å®½ä¼°è®¡ç®—æ³•ï¼Œä½†å¯ä»¥æ‰‹åŠ¨æ§åˆ¶ï¼š

```javascript
// ä¼ªä»£ç ï¼šåŠ¨æ€è°ƒæ•´ç ç‡

// ç›‘å¬ç»Ÿè®¡ä¿¡æ¯
setInterval(async () => {
    stats = await pc.getStats();
    
    for (report of stats.values()) {
        if (report.type === 'inbound-rtp' && report.kind === 'video') {
            // è®¡ç®—ä¸¢åŒ…ç‡
            packetsLost = report.packetsLost;
            packetsReceived = report.packetsReceived;
            lossRate = packetsLost / (packetsLost + packetsReceived);
            
            // è®¡ç®—å½“å‰ç ç‡
            bytesReceived = report.bytesReceived;
            currentBitrate = (bytesReceived - lastBytes) * 8 / 1000;  // kbps
            lastBytes = bytesReceived;
            
            console.log(`ä¸¢åŒ…ç‡: ${lossRate * 100}%`);
            console.log(`å½“å‰ç ç‡: ${currentBitrate} kbps`);
            
            // æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´
            if (lossRate > 0.05) {  // ä¸¢åŒ…ç‡>5%
                // é™ä½åˆ†è¾¨ç‡
                sender.setParameters({
                    encodings: [{
                        maxBitrate: 500000  // 500kbps
                    }]
                });
            }
        }
    }
}, 1000);
```

### Simulcast - åŒæ—¶ç¼–ç å¤šç§è´¨é‡

```javascript
// ä¼ªä»£ç ï¼šå¯ç”¨Simulcast

pc.addTransceiver('video', {
    direction: 'sendonly',
    sendEncodings: [
        { rid: 'h', maxBitrate: 1500000 },  // é«˜æ¸… 1.5Mbps
        { rid: 'm', maxBitrate: 600000, scaleResolutionDownBy: 2 },  // ä¸­æ¸…
        { rid: 'l', maxBitrate: 200000, scaleResolutionDownBy: 4 }   // ä½æ¸…
    ]
});

// SFUæœåŠ¡å™¨å¯ä»¥æ ¹æ®æ¯ä¸ªæ¥æ”¶è€…çš„ç½‘ç»œçŠ¶å†µ
// è½¬å‘ä¸åŒè´¨é‡çš„æµ
```

### å¸¸è§é—®é¢˜æ’æŸ¥

```
é—®é¢˜1ï¼šæ— æ³•å»ºç«‹è¿æ¥

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ICEè¿æ¥çŠ¶æ€
   console.log(pc.iceConnectionState);
   
   å¦‚æœä¸€ç›´æ˜¯ "checking"ï¼š
   - å¯èƒ½æ˜¯é˜²ç«å¢™é˜»æ­¢
   - å¯èƒ½éœ€è¦TURNæœåŠ¡å™¨
   
2. æ£€æŸ¥ICEå€™é€‰è€…
   pc.onicecandidate = (e) => {
       console.log("å€™é€‰è€…:", e.candidate);
   }
   
   å¦‚æœæ²¡æœ‰ srflx å€™é€‰è€…ï¼š
   - STUNæœåŠ¡å™¨ä¸å¯è¾¾
   
   å¦‚æœæ²¡æœ‰ relay å€™é€‰è€…ï¼š
   - TURNæœåŠ¡å™¨é…ç½®é”™è¯¯

3. æ£€æŸ¥SDP
   console.log(offer.sdp);
   
   æŸ¥çœ‹æ˜¯å¦åŒ…å«æœŸæœ›çš„ç¼–è§£ç å™¨

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

é—®é¢˜2ï¼šè§†é¢‘å¡é¡¿

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç½‘ç»œç»Ÿè®¡
   stats = await pc.getStats();
   
   å…³æ³¨æŒ‡æ ‡ï¼š
   - packetsLostï¼ˆä¸¢åŒ…ï¼‰
   - jitterï¼ˆæŠ–åŠ¨ï¼‰
   - roundTripTimeï¼ˆå¾€è¿”å»¶è¿Ÿï¼‰

2. æ£€æŸ¥å¸§ç‡å’Œåˆ†è¾¨ç‡
   videoTrack.getSettings()
   
   å¯èƒ½éœ€è¦é™ä½é…ç½®

3. æ£€æŸ¥CPUä½¿ç”¨ç‡
   å¦‚æœCPUè¿‡é«˜ï¼š
   - åˆ‡æ¢åˆ°ç¡¬ä»¶ç¼–ç 
   - é™ä½åˆ†è¾¨ç‡

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

é—®é¢˜3ï¼šéŸ³ç”»ä¸åŒæ­¥

åŸå› ï¼š
- éŸ³é¢‘å’Œè§†é¢‘çš„æ—¶é’Ÿä¸ä¸€è‡´
- ç½‘ç»œæŠ–åŠ¨å¯¼è‡´å»¶è¿Ÿä¸åŒ

è§£å†³ï¼š
// ä½¿ç”¨ç»Ÿä¸€çš„æ—¶é’Ÿæº
audioTrack = localStream.getAudioTracks()[0];
videoTrack = localStream.getVideoTracks()[0];

// ç¡®ä¿æ·»åŠ åˆ°åŒä¸€ä¸ªæµ
stream = new MediaStream([audioTrack, videoTrack]);
pc.addTrack(audioTrack, stream);
pc.addTrack(videoTrack, stream);

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

é—®é¢˜4ï¼šå›å£°é—®é¢˜

è§£å†³æ–¹æ¡ˆï¼š
1. å¯ç”¨å›å£°æ¶ˆé™¤
   getUserMedia({
       audio: {
           echoCancellation: true,
           noiseSuppression: true,
           autoGainControl: true
       }
   })

2. ä½¿ç”¨è€³æœºï¼ˆæœ€ç®€å•æœ‰æ•ˆï¼‰

3. è°ƒæ•´éŸ³é‡
   audioTrack.applyConstraints({
       volume: 0.8
   })
```

### æ€§èƒ½ç›‘æ§é¢æ¿

```javascript
// ä¼ªä»£ç ï¼šå®æ—¶ç›‘æ§é¢æ¿

class WebRTCMonitor {
    async getMetrics() {
        stats = await pc.getStats();
        
        metrics = {
            video: {
                resolution: "1280x720",
                frameRate: 30,
                bitrate: 1500,  // kbps
                packetsLost: 45,
                totalPackets: 10000,
                lossRate: 0.45,  // %
                codec: "VP8"
            },
            audio: {
                bitrate: 64,  // kbps
                packetsLost: 12,
                codec: "Opus"
            },
            connection: {
                localCandidate: "192.168.1.100:54321 (host)",
                remoteCandidate: "1.2.3.4:6000 (srflx)",
                rtt: 45,  // ms
                availableBitrate: 2000  // kbps
            }
        };
        
        return metrics;
    }
    
    displayDashboard(metrics) {
        console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       WebRTC æ€§èƒ½ç›‘æ§é¢æ¿              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ è§†é¢‘ï¼š                                â•‘
â•‘   åˆ†è¾¨ç‡: ${metrics.video.resolution}  â•‘
â•‘   å¸§ç‡: ${metrics.video.frameRate} fps â•‘
â•‘   ç ç‡: ${metrics.video.bitrate} kbps  â•‘
â•‘   ä¸¢åŒ…ç‡: ${metrics.video.lossRate}%   â•‘
â•‘   ç¼–ç : ${metrics.video.codec}         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ éŸ³é¢‘ï¼š                                â•‘
â•‘   ç ç‡: ${metrics.audio.bitrate} kbps  â•‘
â•‘   ç¼–ç : ${metrics.audio.codec}         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ è¿æ¥ï¼š                                â•‘
â•‘   RTT: ${metrics.connection.rtt} ms    â•‘
â•‘   å¸¦å®½: ${metrics.connection.availableBitrate} kbps â•‘
â•‘   è·¯å¾„: ${metrics.connection.localCandidate} â•‘
â•‘      â†”  ${metrics.connection.remoteCandidate} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        `);
    }
}
```

---

## å®‰å…¨æ€§è€ƒè™‘

### å†…ç½®å®‰å…¨æœºåˆ¶

```
WebRTCçš„å®‰å…¨è®¾è®¡ï¼š

1. å¼ºåˆ¶åŠ å¯†
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  åª’ä½“æ•°æ®     â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   SRTPåŠ å¯†   â”‚ â† AES-128åŠ å¯†
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   DTLSæ¡æ‰‹   â”‚ â† TLS 1.2+
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
      UDPä¼ è¾“

2. è¯ä¹¦éªŒè¯
   - æ¯ä¸ªPeerConnectionç”Ÿæˆè‡ªç­¾åè¯ä¹¦
   - é€šè¿‡SDPäº¤æ¢è¯ä¹¦æŒ‡çº¹
   - DTLSæ¡æ‰‹æ—¶éªŒè¯
   
3. åŒæºç­–ç•¥
   - getUserMediaéœ€è¦HTTPS
   - æˆ–è€…localhostï¼ˆå¼€å‘ç”¨ï¼‰

4. æƒé™æ§åˆ¶
   - æ‘„åƒå¤´/éº¦å…‹é£éœ€è¦ç”¨æˆ·æˆæƒ
   - å±å¹•å…±äº«éœ€è¦ç”¨æˆ·é€‰æ‹©
```

### æ½œåœ¨å®‰å…¨é£é™©

```
é£é™©1ï¼šä¿¡ä»¤åŠ«æŒ
   æ”»å‡»è€…åŠ«æŒä¿¡ä»¤ï¼Œæ›¿æ¢SDPä¸­çš„è¯ä¹¦æŒ‡çº¹
   
   é˜²æŠ¤ï¼š
   - ä¿¡ä»¤é€šé“ä½¿ç”¨HTTPS/WSS
   - å®ç°ç«¯åˆ°ç«¯åŠ å¯†çš„ä¿¡ä»¤
   - éªŒè¯å¯¹æ–¹èº«ä»½ï¼ˆå¦‚æ˜¾ç¤ºè¯ä¹¦æŒ‡çº¹è®©ç”¨æˆ·æ ¸å¯¹ï¼‰

é£é™©2ï¼šä¸­é—´äººæ”»å‡»ï¼ˆTURNæœåŠ¡å™¨ï¼‰
   æ¶æ„TURNæœåŠ¡å™¨å¯ä»¥çªƒå¬æ•°æ®
   
   é˜²æŠ¤ï¼š
   - ä½¿ç”¨å¯ä¿¡çš„TURNæœåŠ¡å™¨
   - å¯ç”¨TURN over TLS

é£é™©3ï¼šèµ„æºè€—å°½æ”»å‡»
   æ”»å‡»è€…å‘èµ·å¤§é‡è¿æ¥è¯·æ±‚
   
   é˜²æŠ¤ï¼š
   - ä¿¡ä»¤å±‚é¢é™æµ
   - éªŒè¯èº«ä»½åæ‰å»ºç«‹è¿æ¥

é£é™©4ï¼šéšç§æ³„éœ²
   è·å–IPåœ°å€ã€è®¾å¤‡æŒ‡çº¹
   
   é˜²æŠ¤ï¼š
   - ä½¿ç”¨ä¸­ç»§æ¨¡å¼ï¼ˆä»…é€šè¿‡TURNï¼‰
   - æµè§ˆå™¨éšç§æ¨¡å¼
```

---

## ä¸å…¶ä»–æŠ€æœ¯å¯¹æ¯”

### WebRTC vs WebSocket

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç‰¹æ€§         â”‚    WebRTC       â”‚   WebSocket     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¼ è¾“å±‚         â”‚  UDP (ä¸»è¦)     â”‚   TCP           â”‚
â”‚  å»¶è¿Ÿ           â”‚  æä½ (50-150ms)â”‚   ä½ (100-300ms)â”‚
â”‚  å¯é æ€§         â”‚  ä¸ä¿è¯         â”‚   ä¿è¯          â”‚
â”‚  åŠ å¯†           â”‚  å¼ºåˆ¶ (SRTP)    â”‚   å¯é€‰ (WSS)    â”‚
â”‚  P2P           â”‚  æ˜¯             â”‚   å¦            â”‚
â”‚  åª’ä½“ä¼˜åŒ–       â”‚  å†…ç½®           â”‚   æ—             â”‚
â”‚  é€‚ç”¨åœºæ™¯       â”‚  å®æ—¶éŸ³è§†é¢‘     â”‚   æ¶ˆæ¯ã€é€šçŸ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‰æ‹©å»ºè®®ï¼š
âœ… éŸ³è§†é¢‘é€šè¯ â†’ WebRTC
âœ… æ–‡ä»¶ä¼ è¾“ï¼ˆå¤§æ–‡ä»¶ï¼‰â†’ WebRTC DataChannel
âœ… èŠå¤©æ¶ˆæ¯ â†’ WebSocket
âœ… æ¸¸æˆçŠ¶æ€åŒæ­¥ â†’ WebRTC DataChannelï¼ˆä½å»¶è¿Ÿï¼‰
âœ… è®¢å•æ¨é€ â†’ WebSocket
```

### WebRTC vs HLS/DASH

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç‰¹æ€§         â”‚    WebRTC       â”‚   HLS/DASH      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å»¶è¿Ÿ           â”‚  0.5-2ç§’        â”‚   5-30ç§’        â”‚
â”‚  è§„æ¨¡           â”‚  å°è§„æ¨¡ (<50)   â”‚   å¤§è§„æ¨¡ (ä¸‡+)  â”‚
â”‚  CDNæ”¯æŒ        â”‚  å›°éš¾           â”‚   ä¼˜ç§€          â”‚
â”‚  æµè§ˆå™¨å…¼å®¹     â”‚  éœ€è¦JS         â”‚   åŸç”Ÿ <video>  â”‚
â”‚  æœåŠ¡å™¨æˆæœ¬     â”‚  é«˜ (SFU)       â”‚   ä½ (CDN)      â”‚
â”‚  é€‚ç”¨åœºæ™¯       â”‚  äº’åŠ¨ç›´æ’­       â”‚   ç‚¹æ’­ã€å¤§è§„æ¨¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›´æ’­åœºæ™¯é€‰æ‹©ï¼š
- æ‹å–ã€ç«çŒœï¼ˆå¼ºäº’åŠ¨ï¼‰â†’ WebRTC
- æ¸¸æˆç›´æ’­ï¼ˆå•å‘ï¼‰â†’ HLS + WebSocketï¼ˆå¼¹å¹•ï¼‰
- å¤§è§„æ¨¡å‘å¸ƒä¼š â†’ HLS
```

---

## æœªæ¥å‘å±•è¶‹åŠ¿

### 1. WebRTC NVï¼ˆä¸‹ä¸€ä»£ï¼‰

```
æ”¹è¿›æ–¹å‘ï¼š
- æ›´å¥½çš„æ‹¥å¡æ§åˆ¶ç®—æ³•
- åŸç”Ÿæ”¯æŒSimulcast
- æ›´çµæ´»çš„API
- AV1ç¼–è§£ç å™¨æ”¯æŒ
```

### 2. WebCodecs API

```
// æ›´åº•å±‚çš„ç¼–è§£ç æ§åˆ¶

videoEncoder = new VideoEncoder({
    output: (chunk) => {
        // è‡ªå®šä¹‰å¤„ç†ç¼–ç åçš„æ•°æ®
        customTransport.send(chunk);
    },
    error: (e) => console.error(e)
});

videoEncoder.configure({
    codec: 'avc1.42E01E',  // H.264 Baseline
    width: 1280,
    height: 720,
    bitrate: 2000000,
    framerate: 30
});

videoEncoder.encode(frame);
```

### 3. WebTransport

```
// æ–°çš„ä¼ è¾“åè®®ï¼ŒåŸºäºQUIC

transport = new WebTransport('https://example.com:4433/foo');
await transport.ready;

// åˆ›å»ºå•å‘æµ
stream = await transport.createUnidirectionalStream();
writer = stream.writable.getWriter();
await writer.write(data);

ä¼˜åŠ¿ï¼š
- æ¯”WebRTC DataChannelæ›´çµæ´»
- æ¯”WebSocketæ›´ä½å»¶è¿Ÿ
- å¤šè·¯å¤ç”¨ä¸äº’ç›¸é˜»å¡
```

### 4. æœºå™¨å­¦ä¹ é›†æˆ

```
åº”ç”¨ï¼š
- å®æ—¶èƒŒæ™¯æ›¿æ¢ï¼ˆæ›´å‡†ç¡®ï¼‰
- å™ªå£°æ¶ˆé™¤ï¼ˆAIé™å™ªï¼‰
- è‡ªåŠ¨ä¼šè®®çºªè¦
- å®æ—¶ç¿»è¯‘å­—å¹•
- äººè„¸ç¾åŒ–
```

---

## å­¦ä¹ èµ„æºæ¨è

### å®˜æ–¹æ–‡æ¡£
- MDN WebRTC API: https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API
- W3C WebRTCè§„èŒƒ: https://www.w3.org/TR/webrtc/

### å¼€æºé¡¹ç›®
- **mediasoup**: å¼ºå¤§çš„SFUæœåŠ¡å™¨
- **Janus**: å¤šåŠŸèƒ½WebRTCç½‘å…³
- **Jitsi**: å®Œæ•´çš„è§†é¢‘ä¼šè®®è§£å†³æ–¹æ¡ˆ
- **SimpleWebRTC**: ç®€åŒ–çš„WebRTCåº“

### åœ¨çº¿å·¥å…·
- **webrtc-internals**: Chromeå†…ç½®è°ƒè¯•å·¥å…·ï¼ˆchrome://webrtc-internalsï¼‰
- **test.webrtc.org**: å®˜æ–¹æµ‹è¯•å·¥å…·
- **Trickle ICE**: æµ‹è¯•ICEå€™é€‰è€…æ”¶é›†

### å®è·µå»ºè®®

```
å­¦ä¹ è·¯å¾„ï¼š

ç¬¬1å‘¨ï¼šåŸºç¡€æ¦‚å¿µ
â”œâ”€ ç†è§£P2Pé€šä¿¡
â”œâ”€ å­¦ä¹ ä¿¡ä»¤æ¦‚å¿µ
â””â”€ è¿è¡Œç¬¬ä¸€ä¸ªDemo

ç¬¬2å‘¨ï¼šæ ¸å¿ƒAPI
â”œâ”€ getUserMedia
â”œâ”€ RTCPeerConnection
â””â”€ createOffer/Answer

ç¬¬3å‘¨ï¼šNATç©¿é€
â”œâ”€ é…ç½®STUNæœåŠ¡å™¨
â”œâ”€ ç†è§£ICEå€™é€‰è€…
â””â”€ æ­å»ºTURNæœåŠ¡å™¨

ç¬¬4å‘¨ï¼šå®æˆ˜é¡¹ç›®
â”œâ”€ 1å¯¹1è§†é¢‘é€šè¯
â”œâ”€ æ·»åŠ å±å¹•å…±äº«
â”œâ”€ å®ç°èŠå¤©åŠŸèƒ½
â””â”€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

æŒç»­æå‡ï¼š
â”œâ”€ æ€§èƒ½ä¼˜åŒ–
â”œâ”€ é”™è¯¯å¤„ç†
â”œâ”€ å¤šæ–¹é€šè¯
â””â”€ å½•åˆ¶å›æ”¾
```

---

## æ€»ç»“

WebRTCæŠ€æœ¯è¦ç‚¹å›é¡¾ï¼š

```
æ ¸å¿ƒæ¦‚å¿µï¼š
â”œâ”€ P2Pé€šä¿¡ï¼šç›´æ¥è¿æ¥ï¼Œä½å»¶è¿Ÿ
â”œâ”€ ä¸‰å¤§APIï¼šMediaStream, PeerConnection, DataChannel
â””â”€ å®‰å…¨ç¬¬ä¸€ï¼šå¼ºåˆ¶åŠ å¯†

å…³é”®æµç¨‹ï¼š
1. ä¿¡ä»¤äº¤æ¢ï¼ˆOffer/Answerï¼‰
2. ICEå€™é€‰è€…æ”¶é›†
3. è¿é€šæ€§æ£€æŸ¥
4. åª’ä½“ä¼ è¾“

æŠ€æœ¯æ ˆï¼š
åº”ç”¨å±‚ï¼šJavaScript API
ä¼šè¯å±‚ï¼šSDPåå•†
ä¼ è¾“å±‚ï¼šSRTP/SCTP
ç½‘ç»œå±‚ï¼šICE/STUN/TURN
åº•å±‚ï¼šUDP/TCP

å®æˆ˜è¦ç‚¹ï¼š
âœ… é€‰æ‹©åˆé€‚çš„æ¶æ„ï¼ˆMesh/SFU/MCUï¼‰
âœ… é…ç½®å¯é çš„ICEæœåŠ¡å™¨
âœ… å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†
âœ… ä¼˜åŒ–æ€§èƒ½å’Œå¸¦å®½
âœ… ä¿éšœå®‰å…¨å’Œéšç§

æœªæ¥æ–¹å‘ï¼š
- WebCodecsï¼šæ›´åº•å±‚æ§åˆ¶
- WebTransportï¼šæ–°ä¼ è¾“åè®®
- AIé›†æˆï¼šæ™ºèƒ½åŒ–å¤„ç†
```

WebRTCè™½ç„¶å¤æ‚ï¼Œä½†å®ƒä¸ºWebå¸¦æ¥äº†çœŸæ­£çš„å®æ—¶é€šä¿¡èƒ½åŠ›ã€‚æŒæ¡WebRTCï¼Œä½ å°±èƒ½æ„å»ºå‡ºè‰²çš„å®æ—¶åº”ç”¨ï¼

ç»§ç»­æ¢ç´¢ï¼Œå®è·µå‡ºçœŸçŸ¥ï¼ğŸš€
